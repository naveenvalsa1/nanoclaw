<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Andy Dashboard</title>
    <style>
/* ============================================================
   Dashboard CSS - Design System & Component Library
   ============================================================ */

/* --- Google Fonts --- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

/* ============================================================
   CSS Custom Properties (Dark Mode Default)
   ============================================================ */
:root {
  /* --- Colors: Surfaces --- */
  --color-base: #0a0a0f;
  --color-surface: #12121a;
  --color-card-surface: #1a1a2e;
  --color-elevated-surface: #22223a;

  /* --- Colors: Accent --- */
  --color-accent: #6366f1;
  --color-accent-hover: #5558e6;
  --color-accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6, #a78bfa);
  --color-accent-soft: rgba(99, 102, 241, 0.12);
  --color-accent-ring: rgba(99, 102, 241, 0.4);

  /* --- Colors: Text --- */
  --color-text-primary: #f0f0f5;
  --color-text-secondary: #8b8ba0;
  --color-text-tertiary: #5a5a72;
  --color-text-inverse: #0a0a0f;

  /* --- Colors: Borders --- */
  --color-border: rgba(255, 255, 255, 0.06);
  --color-border-hover: rgba(255, 255, 255, 0.12);
  --color-border-active: rgba(99, 102, 241, 0.4);

  /* --- Colors: Calendar Categories --- */
  --cal-important: #6366f1;
  --cal-routine: #10b981;
  --cal-work: #3b82f6;
  --cal-birthdays: #ec4899;
  --cal-holidays: #f59e0b;

  /* --- Colors: Status --- */
  --color-success: #10b981;
  --color-warning: #f59e0b;
  --color-danger: #ef4444;
  --color-info: #3b82f6;

  /* --- Colors: Priority --- */
  --priority-high: #ef4444;
  --priority-medium: #f59e0b;
  --priority-low: #10b981;

  /* --- Shadows --- */
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3);
  --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.6), 0 8px 20px rgba(0, 0, 0, 0.4);
  --shadow-accent: 0 4px 16px rgba(99, 102, 241, 0.25);

  /* --- Glass --- */
  --glass-bg: rgba(18, 18, 26, 0.75);
  --glass-border: rgba(255, 255, 255, 0.06);

  /* --- Typography --- */
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;

  --text-badge: 12px;
  --text-body: 14px;
  --text-card-title: 15px;
  --text-section-title: 18px;
  --text-hero: 32px;

  --leading-tight: 1.25;
  --leading-normal: 1.5;
  --leading-relaxed: 1.625;

  /* --- Spacing --- */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 20px;
  --space-6: 24px;
  --space-8: 32px;
  --space-10: 40px;
  --space-12: 48px;

  /* --- Radii --- */
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 10px;
  --radius-xl: 12px;
  --radius-2xl: 16px;
  --radius-full: 9999px;

  /* --- Transitions --- */
  --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
  --duration-fast: 150ms;
  --duration-normal: 200ms;
  --duration-slow: 300ms;
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);

  /* --- Layout --- */
  --sidebar-width: 260px;
  --topbar-height: 56px;

  /* --- Z-Index Scale --- */
  --z-base: 1;
  --z-dropdown: 50;
  --z-sidebar: 100;
  --z-sticky: 110;
  --z-overlay: 199;
  --z-side-sheet: 200;
  --z-notification: 300;
  --z-modal: 500;
  --z-command: 1000;

  /* --- Scrollbar --- */
  --scrollbar-width: 6px;
  --scrollbar-thumb: rgba(255, 255, 255, 0.12);
  --scrollbar-thumb-hover: rgba(255, 255, 255, 0.2);
  --scrollbar-track: transparent;
}

/* ============================================================
   Light Mode - Manual Override
   ============================================================ */
[data-theme="light"] {
  --color-base: #f8f9fc;
  --color-surface: #ffffff;
  --color-card-surface: #f0f0f5;
  --color-elevated-surface: #e8e8f0;

  --color-text-primary: #111118;
  --color-text-secondary: #6b6b80;
  --color-text-tertiary: #9a9ab0;
  --color-text-inverse: #f0f0f5;

  --color-border: rgba(0, 0, 0, 0.08);
  --color-border-hover: rgba(0, 0, 0, 0.15);
  --color-border-active: rgba(99, 102, 241, 0.4);

  --color-accent-soft: rgba(99, 102, 241, 0.08);

  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
  --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.06);
  --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.12), 0 8px 20px rgba(0, 0, 0, 0.06);
  --shadow-accent: 0 4px 16px rgba(99, 102, 241, 0.15);

  --glass-bg: rgba(255, 255, 255, 0.75);
  --glass-border: rgba(0, 0, 0, 0.06);

  --scrollbar-thumb: rgba(0, 0, 0, 0.15);
  --scrollbar-thumb-hover: rgba(0, 0, 0, 0.25);
}

/* Dark Mode - Manual Override (mirrors :root for explicit toggling) */
[data-theme="dark"] {
  --color-base: #0a0a0f;
  --color-surface: #12121a;
  --color-card-surface: #1a1a2e;
  --color-elevated-surface: #22223a;

  --color-text-primary: #f0f0f5;
  --color-text-secondary: #8b8ba0;
  --color-text-tertiary: #5a5a72;
  --color-text-inverse: #0a0a0f;

  --color-border: rgba(255, 255, 255, 0.06);
  --color-border-hover: rgba(255, 255, 255, 0.12);
  --color-border-active: rgba(99, 102, 241, 0.4);

  --color-accent-soft: rgba(99, 102, 241, 0.12);

  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3);
  --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.6), 0 8px 20px rgba(0, 0, 0, 0.4);
  --shadow-accent: 0 4px 16px rgba(99, 102, 241, 0.25);

  --glass-bg: rgba(18, 18, 26, 0.75);
  --glass-border: rgba(255, 255, 255, 0.06);

  --scrollbar-thumb: rgba(255, 255, 255, 0.12);
  --scrollbar-thumb-hover: rgba(255, 255, 255, 0.2);
}

/* Light mode auto-detection for users without manual override */
@media (prefers-color-scheme: light) {
  :root:not([data-theme]) {
    --color-base: #f8f9fc;
    --color-surface: #ffffff;
    --color-card-surface: #f0f0f5;
    --color-elevated-surface: #e8e8f0;

    --color-text-primary: #111118;
    --color-text-secondary: #6b6b80;
    --color-text-tertiary: #9a9ab0;
    --color-text-inverse: #f0f0f5;

    --color-border: rgba(0, 0, 0, 0.08);
    --color-border-hover: rgba(0, 0, 0, 0.15);
    --color-border-active: rgba(99, 102, 241, 0.4);

    --color-accent-soft: rgba(99, 102, 241, 0.08);

    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
    --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.06);
    --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.12), 0 8px 20px rgba(0, 0, 0, 0.06);
    --shadow-accent: 0 4px 16px rgba(99, 102, 241, 0.15);

    --glass-bg: rgba(255, 255, 255, 0.75);
    --glass-border: rgba(0, 0, 0, 0.06);

    --scrollbar-thumb: rgba(0, 0, 0, 0.15);
    --scrollbar-thumb-hover: rgba(0, 0, 0, 0.25);
  }
}

/* ============================================================
   Keyframe Animations
   ============================================================ */
@keyframes countUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(12px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

@keyframes notification-pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
  }
  70% {
    box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* ============================================================
   Global Reset & Base
   ============================================================ */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  font-size: 16px;
  -webkit-text-size-adjust: 100%;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

body {
  font-family: var(--font-sans);
  font-size: var(--text-body);
  line-height: var(--leading-normal);
  color: var(--color-text-primary);
  background-color: var(--color-base);
  overflow-x: hidden;
  transition: background-color var(--transition-slow), color var(--transition-slow);
}

a {
  color: var(--color-accent);
  text-decoration: none;
  transition: color var(--transition-fast);
}

a:hover {
  color: var(--color-accent-hover);
}

img {
  max-width: 100%;
  display: block;
}

/* ============================================================
   Scrollbar Styling
   ============================================================ */
::-webkit-scrollbar {
  width: var(--scrollbar-width);
  height: var(--scrollbar-width);
}

::-webkit-scrollbar-track {
  background: var(--scrollbar-track);
}

::-webkit-scrollbar-thumb {
  background: var(--scrollbar-thumb);
  border-radius: var(--radius-full);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--scrollbar-thumb-hover);
}

* {
  scrollbar-width: thin;
  scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
}

/* ============================================================
   Layout: App Container
   ============================================================ */
.app-container {
  display: flex;
  min-height: 100vh;
  background-color: var(--color-base);
}

/* ============================================================
   Layout: Sidebar
   ============================================================ */
.sidebar {
  width: var(--sidebar-width);
  position: fixed;
  left: 0;
  top: 0;
  height: 100vh;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-right: 1px solid var(--glass-border);
  z-index: var(--z-sidebar);
  display: flex;
  flex-direction: column;
  transition: transform var(--transition-slow);
  overflow-y: auto;
  overflow-x: hidden;
}

.sidebar-header {
  padding: var(--space-5) var(--space-5) var(--space-4);
  border-bottom: 1px solid var(--color-border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: var(--space-4);
}

.sidebar-header .logo {
  font-size: var(--text-section-title);
  font-weight: 700;
  color: var(--color-text-primary);
  letter-spacing: -0.02em;
}

.sidebar-header .logo-subtitle {
  font-size: 12px;
  color: var(--color-text-tertiary);
  margin-top: 2px;
}

/* --- Andy Face --- */
.andy-face {
  width: 48px;
  height: 48px;
  background: var(--color-accent-gradient);
  border-radius: 50%;
  position: relative;
  flex-shrink: 0;
}

.andy-face .face-eyes {
  position: absolute;
  top: 14px;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
}

.andy-face .eye {
  width: 6px;
  height: 6px;
  background: white;
  border-radius: 50%;
  animation: blink 4s infinite;
}

.andy-face .face-mouth {
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  width: 16px;
  height: 8px;
  border: 2px solid white;
  border-top: none;
  border-radius: 0 0 16px 16px;
}

.andy-face .status-indicator {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 2px solid var(--color-surface);
  background: #10b981;
  animation: pulse 2s infinite;
}

.andy-face .status-indicator.working {
  background: #f59e0b;
}

@keyframes blink {
  0%, 45%, 55%, 100% { transform: scaleY(1); }
  50% { transform: scaleY(0.1); }
}

/* --- Sidebar Stats Widget --- */
.sidebar-stat-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-2) var(--space-3);
  font-size: 13px;
}

.sidebar-stat-label {
  color: var(--color-text-secondary);
}

.sidebar-stat-value {
  font-weight: 600;
  color: var(--color-text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
}

/* --- Sidebar Navigation --- */
.sidebar-nav {
  padding: var(--space-3) var(--space-3);
  flex: 1;
  overflow-y: auto;
}

.sidebar-nav .nav-section-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--color-text-tertiary);
  padding: var(--space-4) var(--space-3) var(--space-2);
}

.nav-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: var(--space-3);
  padding: 10px 12px;
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  font-size: var(--text-body);
  font-weight: 500;
  cursor: pointer;
  transition: background-color var(--transition-fast), color var(--transition-fast);
  user-select: none;
  position: relative;
  text-decoration: none;
}

.nav-item:hover {
  background-color: var(--color-accent-soft);
  color: var(--color-text-primary);
}

.nav-item.active {
  background-color: var(--color-accent);
  color: #ffffff;
}

.nav-item.active:hover {
  background-color: var(--color-accent-hover);
}

.nav-item .nav-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
}

.nav-item.active .nav-icon {
  opacity: 1;
}

.nav-item .nav-label {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.nav-item .nav-badge {
  margin-left: auto;
  font-size: var(--text-badge);
  font-weight: 600;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  background-color: var(--color-accent-soft);
  color: var(--color-accent);
  line-height: 1.4;
  flex-shrink: 0;
}
.nav-item .nav-badge:empty {
  display: none;
}

.nav-item.active .nav-badge {
  background-color: rgba(255, 255, 255, 0.2);
  color: #ffffff;
}

/* --- Sidebar Widgets --- */
.sidebar-widgets {
  padding: var(--space-3);
  border-top: 1px solid var(--color-border);
  flex-shrink: 0;
}

.sidebar-widgets .widget-title {
  font-size: var(--text-badge);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--color-text-tertiary);
  padding: var(--space-2) var(--space-3) var(--space-2);
}

.sidebar-mini-calendar {
  padding: var(--space-2) var(--space-3);
}

.sidebar-mini-calendar .mini-cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  text-align: center;
  font-size: 11px;
}

.sidebar-mini-calendar .mini-cal-day {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: background-color var(--transition-fast);
}

.sidebar-mini-calendar .mini-cal-day:hover {
  background-color: var(--color-accent-soft);
}

.sidebar-mini-calendar .mini-cal-day.today {
  background-color: var(--color-accent);
  color: #ffffff;
  font-weight: 600;
}

.sidebar-mini-calendar .mini-cal-day.has-event {
  position: relative;
}

.sidebar-mini-calendar .mini-cal-day.has-event::after {
  content: '';
  position: absolute;
  bottom: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background-color: var(--color-accent);
}

.sidebar-current-work {
  padding: var(--space-2) var(--space-3);
  font-size: 13px;
  color: var(--color-text-secondary);
}

.sidebar-current-work .current-task {
  padding: var(--space-2) var(--space-3);
  background-color: var(--color-accent-soft);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--color-accent);
  color: var(--color-text-primary);
  font-weight: 500;
}

/* --- Sidebar Footer --- */
.sidebar-footer {
  padding: var(--space-3) var(--space-4);
  border-top: 1px solid var(--color-border);
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.theme-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-md);
  cursor: pointer;
  font-size: 13px;
  color: var(--color-text-secondary);
  transition: background-color var(--transition-fast);
}

.theme-toggle:hover {
  background-color: var(--color-accent-soft);
}

.theme-toggle .toggle-track {
  width: 36px;
  height: 20px;
  border-radius: var(--radius-full);
  background-color: var(--color-card-surface);
  border: 1px solid var(--color-border);
  position: relative;
  transition: background-color var(--transition-fast);
}

.theme-toggle .toggle-track .toggle-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background-color: var(--color-text-secondary);
  position: absolute;
  top: 1px;
  left: 1px;
  transition: transform var(--transition-fast), background-color var(--transition-fast);
}

.theme-toggle.active .toggle-track {
  background-color: var(--color-accent);
}

.theme-toggle.active .toggle-track .toggle-thumb {
  transform: translateX(16px);
  background-color: #ffffff;
}

.sidebar-footer .keyboard-hint {
  font-size: 11px;
  color: var(--color-text-tertiary);
  text-align: center;
  padding: var(--space-1) 0;
}

.sidebar-footer .keyboard-hint kbd {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 1px 5px;
  border-radius: 4px;
  background-color: var(--color-card-surface);
  border: 1px solid var(--color-border);
  color: var(--color-text-secondary);
}

/* ============================================================
   Layout: Main Content
   ============================================================ */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-width);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* --- Top Bar --- */
.top-bar {
  position: sticky;
  top: 0;
  height: var(--topbar-height);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--space-8);
  border-bottom: 1px solid var(--color-border);
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: var(--z-sticky);
  flex-shrink: 0;
}

.top-bar-left {
  display: flex;
  align-items: center;
  gap: var(--space-4);
}

.top-bar-left .breadcrumb {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  font-size: 13px;
  color: var(--color-text-secondary);
}

.top-bar-left .breadcrumb .separator {
  color: var(--color-text-tertiary);
}

.top-bar-left .breadcrumb .current {
  color: var(--color-text-primary);
  font-weight: 500;
}

.top-bar-right {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.top-bar-search {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-md);
  background-color: var(--color-card-surface);
  border: 1px solid var(--color-border);
  color: var(--color-text-tertiary);
  font-size: 13px;
  cursor: pointer;
  transition: border-color var(--transition-fast), background-color var(--transition-fast);
  min-width: 200px;
}

.top-bar-search:hover {
  border-color: var(--color-border-hover);
  background-color: var(--color-elevated-surface);
}

.top-bar-search kbd {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 1px 5px;
  border-radius: 4px;
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  margin-left: auto;
}

/* --- View Container --- */
.view-container {
  padding: var(--space-6) var(--space-8);
  flex: 1;
  animation: fadeIn 300ms var(--ease-default);
}

/* --- Hero Greeting --- */
.hero-greeting {
  font-size: var(--text-hero);
  font-weight: 700;
  color: var(--color-text-primary);
  letter-spacing: -0.03em;
  line-height: var(--leading-tight);
  margin-bottom: var(--space-1);
}

.hero-greeting .accent-text {
  background: var(--color-accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero-subtext {
  font-size: var(--text-body);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-8);
}

/* --- Section Title --- */
.section-title {
  font-size: var(--text-section-title);
  font-weight: 600;
  color: var(--color-text-primary);
  letter-spacing: -0.01em;
  margin-bottom: var(--space-4);
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-4);
}

/* ============================================================
   Component: Stat Cards
   ============================================================ */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-5);
  margin-bottom: var(--space-8);
}

.stat-card {
  background-color: var(--color-surface);
  border-radius: var(--radius-xl);
  padding: var(--space-5);
  border: 1px solid var(--color-border);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
  cursor: default;
  animation: slideIn 400ms var(--ease-default) both;
}

.stat-card:nth-child(1) { animation-delay: 0ms; }
.stat-card:nth-child(2) { animation-delay: 60ms; }
.stat-card:nth-child(3) { animation-delay: 120ms; }
.stat-card:nth-child(4) { animation-delay: 180ms; }

.stat-card:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
  border-color: var(--color-border-hover);
}

.stat-card .stat-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: var(--space-3);
  font-size: 18px;
}

.stat-card .stat-icon.accent {
  background-color: var(--color-accent-soft);
  color: var(--color-accent);
}

.stat-card .stat-icon.success {
  background-color: rgba(16, 185, 129, 0.12);
  color: var(--color-success);
}

.stat-card .stat-icon.warning {
  background-color: rgba(245, 158, 11, 0.12);
  color: var(--color-warning);
}

.stat-card .stat-icon.info {
  background-color: rgba(59, 130, 246, 0.12);
  color: var(--color-info);
}

.stat-value {
  font-size: var(--text-hero);
  font-weight: 700;
  color: var(--color-text-primary);
  line-height: var(--leading-tight);
  letter-spacing: -0.02em;
  animation: countUp 600ms var(--ease-default) both;
}

.stat-label {
  font-size: 13px;
  color: var(--color-text-secondary);
  margin-top: var(--space-1);
}

.stat-trend {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: var(--text-badge);
  font-weight: 600;
  margin-top: var(--space-2);
  padding: 2px 8px;
  border-radius: var(--radius-full);
}

.stat-trend.up {
  color: var(--color-success);
  background-color: rgba(16, 185, 129, 0.12);
}

.stat-trend.down {
  color: var(--color-danger);
  background-color: rgba(239, 68, 68, 0.12);
}

/* ============================================================
   Component: Home View Layout
   ============================================================ */
.home-greeting {
  margin-bottom: var(--space-6);
}

.home-greeting h1 {
  font-size: var(--text-hero);
  font-weight: 700;
  color: var(--color-text-primary);
  letter-spacing: -0.02em;
  margin: 0 0 var(--space-1);
}

.home-greeting p {
  font-size: var(--text-body);
  color: var(--color-text-secondary);
  margin: 0;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-5);
  margin-bottom: var(--space-8);
}

.home-sections {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: var(--space-6);
  align-items: start;
}

.home-main {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
}

.home-aside {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
}

.home-section {
  background: var(--color-surface);
  border-radius: var(--radius-xl);
  padding: var(--space-5);
  border: 1px solid var(--color-border);
}

.home-section .section-title {
  margin-bottom: var(--space-4);
  padding-bottom: var(--space-3);
  border-bottom: 1px solid var(--color-border);
}

/* --- Agenda Timeline --- */
.agenda-timeline {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.agenda-item {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3) var(--space-2);
  border-radius: var(--radius-md);
  transition: background var(--transition-fast);
  cursor: default;
}

.agenda-item[onclick] {
  cursor: pointer;
}

.agenda-item:hover {
  background: var(--color-card-surface);
}

.agenda-time {
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text-secondary);
  min-width: 70px;
  font-family: var(--font-mono);
}

.agenda-icon {
  color: var(--color-text-tertiary);
  flex-shrink: 0;
}

.agenda-content {
  flex: 1;
  min-width: 0;
}

.agenda-title {
  font-size: var(--text-body);
  color: var(--color-text-primary);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.agenda-meta {
  font-size: 12px;
  color: var(--color-text-tertiary);
  margin-top: 2px;
}

.agenda-color-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}

/* --- Active Work Cards --- */
.active-work-card {
  padding: var(--space-3) var(--space-3);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background var(--transition-fast);
  border-left: 3px solid transparent;
}

.active-work-card:hover {
  background: var(--color-card-surface);
}

.active-work-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.active-work-title {
  font-size: var(--text-body);
  font-weight: 500;
  color: var(--color-text-primary);
}

.active-work-desc {
  font-size: 13px;
  color: var(--color-text-secondary);
  margin-top: 4px;
  margin-left: 18px;
  line-height: 1.4;
}

/* --- Up Next Cards --- */
.up-next-card {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.up-next-card:hover {
  background: var(--color-card-surface);
}

.up-next-info {
  flex: 1;
  min-width: 0;
}

.up-next-title {
  font-size: var(--text-body);
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.up-next-priority {
  font-size: 12px;
  color: var(--color-text-tertiary);
  text-transform: capitalize;
  margin-top: 2px;
}

/* --- Deadline Cards --- */
.deadline-card {
  padding: var(--space-3);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--color-border);
  margin-bottom: var(--space-2);
}

.deadline-card.urgent {
  border-left-color: #ef4444;
  background: rgba(239, 68, 68, 0.06);
}

.deadline-card.soon {
  border-left-color: #f59e0b;
  background: rgba(245, 158, 11, 0.06);
}

.deadline-title {
  font-size: var(--text-body);
  font-weight: 500;
  color: var(--color-text-primary);
  margin-bottom: 4px;
}

.deadline-time {
  font-size: 12px;
  color: var(--color-text-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
}

/* --- Empty States --- */
.empty-state-small {
  font-size: 13px;
  color: var(--color-text-tertiary);
  text-align: center;
  padding: var(--space-4) var(--space-2);
}

.empty-state-icon {
  color: var(--color-text-tertiary);
  margin-bottom: var(--space-3);
}

/* --- Sidebar Mini Events --- */
.mini-calendar-event {
  display: flex;
  flex-direction: column;
  padding: var(--space-2) var(--space-3);
  border-left: 3px solid var(--color-accent);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  margin-bottom: var(--space-2);
  transition: background var(--transition-fast);
}

.mini-calendar-event:hover {
  background: var(--color-card-surface);
}

.mini-calendar-event.current {
  background: var(--color-accent-soft);
}

.mini-event-time {
  font-size: 11px;
  font-weight: 500;
  color: var(--color-text-secondary);
  font-family: var(--font-mono);
  display: flex;
  align-items: center;
  gap: 4px;
}

.mini-event-title {
  font-size: 13px;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.live-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #10b981;
  display: inline-block;
  animation: pulse 2s ease-in-out infinite;
}

/* --- Sidebar Mini Work --- */
.mini-work-item {
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.mini-work-item:hover {
  background: var(--color-card-surface);
}

.mini-work-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.mini-work-desc {
  font-size: 11px;
  color: var(--color-text-tertiary);
  margin-top: 2px;
}

.calendar-sync {
  font-size: 11px;
  color: var(--color-text-tertiary);
  font-weight: 400;
}

/* --- Tasks Toolbar --- */
.tasks-toolbar {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  margin-bottom: var(--space-5);
}

.task-search-input {
  flex: 1;
  padding: 8px 14px;
  font-size: 13px;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  background: var(--color-surface);
  color: var(--color-text-primary);
  outline: none;
  transition: border-color var(--transition-fast);
  max-width: 280px;
}

.task-search-input:focus {
  border-color: var(--color-accent);
}

.task-filter-select {
  padding: 8px 12px;
  font-size: 13px;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  background: var(--color-surface);
  color: var(--color-text-secondary);
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 28px;
}

.column-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}

/* --- Activity Filters --- */
.activity-filters {
  display: flex;
  gap: var(--space-2);
  margin-bottom: var(--space-5);
  flex-wrap: wrap;
}

.activity-filter-btn {
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 500;
  border-radius: var(--radius-full);
  border: 1px solid var(--color-border);
  background: transparent;
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.activity-filter-btn:hover {
  border-color: var(--color-accent);
  color: var(--color-accent);
}

.activity-filter-btn.active {
  background: var(--color-accent);
  border-color: var(--color-accent);
  color: white;
}

/* --- Notification Header --- */
.notification-header {
  font-size: var(--text-card-title);
  font-weight: 600;
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--color-border);
  color: var(--color-text-primary);
}

/* --- Responsive Home --- */
@media (max-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .home-sections {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
}

/* ============================================================
   Component: Kanban Board
   ============================================================ */
.kanban-board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space-4);
}

.kanban-column {
  min-height: 300px;
  display: flex;
  flex-direction: column;
}

.kanban-column.drag-over .kanban-cards {
  background: var(--color-accent-soft);
  border-radius: var(--radius-lg);
}

.kanban-column-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding-bottom: var(--space-3);
  margin-bottom: var(--space-2);
}

.kanban-column-header .column-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.kanban-column-header .column-count {
  font-size: 11px;
  font-weight: 600;
  padding: 1px 7px;
  border-radius: var(--radius-full);
  background-color: var(--color-card-surface);
  color: var(--color-text-tertiary);
  margin-left: auto;
}

.kanban-cards {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
  padding: var(--space-1);
  transition: background var(--transition-fast);
}

.kanban-empty {
  text-align: center;
  padding: var(--space-6) var(--space-3);
  color: var(--color-text-tertiary);
  font-size: 13px;
}

.task-card {
  background-color: var(--color-surface);
  border-radius: var(--radius-md);
  padding: var(--space-3);
  cursor: pointer;
  border: 1px solid var(--color-border);
  transition: box-shadow var(--transition-fast), border-color var(--transition-fast);
  position: relative;
}

.task-card:hover {
  box-shadow: var(--shadow-sm);
  border-color: var(--color-border-hover);
}

.task-card .task-card-header {
  display: flex;
  align-items: flex-start;
  gap: var(--space-2);
}

.task-card .task-card-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text-primary);
  line-height: 1.4;
  flex: 1;
}

.task-card .task-card-meta {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  margin-top: var(--space-2);
  font-size: 11px;
  color: var(--color-text-tertiary);
}

.task-card .task-deadline {
  display: flex;
  align-items: center;
  gap: 3px;
}

.task-card .task-deadline.overdue {
  color: #ef4444;
}

.task-card .task-priority-label {
  text-transform: capitalize;
}

.task-card .task-card-actions {
  position: absolute;
  top: var(--space-2);
  right: var(--space-2);
  display: flex;
  gap: 2px;
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.task-card:hover .task-card-actions {
  opacity: 1;
}

.task-card .task-card-actions button {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  background: var(--color-surface);
  border-radius: var(--radius-sm);
  color: var(--color-text-tertiary);
  cursor: pointer;
}

.task-card .task-card-actions button:hover {
  color: var(--color-text-primary);
  background: var(--color-card-surface);
}

.task-card .task-card-grip {
  display: none;
}

/* ============================================================
   Component: Side Sheet
   ============================================================ */
.side-sheet-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.3);
  z-index: var(--z-overlay);
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition-slow);
}

.side-sheet-overlay.open {
  opacity: 1;
  pointer-events: auto;
}

.side-sheet {
  position: fixed;
  right: 0;
  top: 0;
  height: 100vh;
  width: 420px;
  background-color: var(--color-surface);
  z-index: var(--z-side-sheet);
  transform: translateX(100%);
  transition: transform var(--transition-slow);
  box-shadow: var(--shadow-xl);
  display: flex;
  flex-direction: column;
  border-left: 1px solid var(--color-border);
}

.side-sheet.open {
  transform: translateX(0);
}

.side-sheet-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-5);
  border-bottom: 1px solid var(--color-border);
  flex-shrink: 0;
}

.side-sheet-header .sheet-title {
  font-size: var(--text-section-title);
  font-weight: 600;
  color: var(--color-text-primary);
}

.side-sheet-body {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-5);
}

.side-sheet-footer {
  padding: var(--space-4) var(--space-5);
  border-top: 1px solid var(--color-border);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: var(--space-3);
  flex-shrink: 0;
}

/* ============================================================
   Component: Calendar (Week View)
   ============================================================ */
.calendar-container {
  background-color: var(--color-surface);
  border-radius: var(--radius-xl);
  border: 1px solid var(--color-border);
  overflow: hidden;
}

.calendar-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-4);
}

.calendar-toolbar .calendar-nav {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.calendar-range {
  font-size: var(--text-body);
  font-weight: 600;
  color: var(--color-text-primary);
  min-width: 180px;
}

.calendar-view-toggle {
  display: flex;
  gap: 0;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  overflow: hidden;
}

.calendar-view-toggle button {
  padding: 6px 14px;
  border: none;
  background: transparent;
  color: var(--color-text-secondary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.calendar-view-toggle button.active {
  background: var(--color-accent);
  color: #fff;
}

/* --- Calendar Grid (cal-* classes) --- */
.cal-week-view,
.cal-day-view {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.cal-headers {
  display: grid;
  grid-template-columns: 56px repeat(7, 1fr);
  border-bottom: 1px solid var(--color-border);
}

.cal-day-view .cal-headers {
  grid-template-columns: 56px 1fr;
}

.cal-header-cell {
  padding: var(--space-3) var(--space-2);
  text-align: center;
}

.cal-header-cell.cal-time-gutter {
  border-right: 1px solid var(--color-border);
}

.cal-day-name {
  display: block;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--color-text-tertiary);
}

.cal-day-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 600;
  color: var(--color-text-primary);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  margin-top: 2px;
}

.cal-today-num {
  background: var(--color-accent);
  color: #fff;
}

.cal-today-header .cal-day-name {
  color: var(--color-accent);
}

.cal-allday-row {
  display: grid;
  grid-template-columns: 56px repeat(7, 1fr);
  border-bottom: 1px solid var(--color-border);
  min-height: 36px;
}

.cal-day-view .cal-allday-row,
.cal-day-allday {
  grid-template-columns: 56px 1fr;
}

.cal-allday-gutter {
  font-size: 10px;
  color: var(--color-text-tertiary);
  padding: var(--space-1) var(--space-2);
  border-right: 1px solid var(--color-border);
  display: flex;
  align-items: center;
}

.cal-allday-cell {
  padding: 2px 4px;
  display: flex;
  flex-wrap: wrap;
  gap: 2px;
}

.cal-allday-event {
  font-size: 12px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 5px;
  cursor: pointer;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: transform 0.1s, box-shadow 0.1s;
}

.cal-allday-event:hover {
  transform: scale(1.02);
  box-shadow: var(--shadow-sm);
}

.cal-body {
  position: relative;
  overflow-y: auto;
  max-height: calc(100vh - 320px);
}

.cal-time-grid {
  position: relative;
}

.cal-time-row {
  display: grid;
  grid-template-columns: 56px repeat(7, 1fr);
  height: 64px;
  border-bottom: 1px solid var(--color-border);
}

.cal-day-view .cal-time-row {
  grid-template-columns: 56px 1fr;
}

.cal-time-row:last-child {
  border-bottom: none;
}

.cal-time-label {
  font-size: 12px;
  color: var(--color-text-tertiary);
  padding: 0 var(--space-2);
  border-right: 1px solid var(--color-border);
  font-family: var(--font-mono);
  position: relative;
  top: -8px;
}

.cal-time-cell {
  border-right: 1px solid var(--color-border);
  position: relative;
  background-image: linear-gradient(to bottom, transparent 49%, var(--color-border) 49%, var(--color-border) 50%, transparent 50%);
  background-size: 100% 100%;
}

.cal-time-cell:last-child {
  border-right: none;
}

.cal-events-layer {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.cal-event-block {
  position: absolute;
  border-radius: 6px;
  padding: 3px 6px;
  font-size: 12px;
  overflow: hidden;
  cursor: pointer;
  pointer-events: auto;
  z-index: 2;
  line-height: 1.3;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: transform 0.1s, box-shadow 0.15s, z-index 0s;
}

.cal-event-block:hover {
  z-index: 3;
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.cal-event-time {
  font-weight: 600;
  font-size: 11px;
  opacity: 0.85;
}

.cal-event-title {
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.cal-event-location {
  font-size: 10px;
  opacity: 0.7;
}

.cal-now-line {
  position: absolute;
  height: 2px;
  background: #ef4444;
  z-index: 10;
  pointer-events: none;
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
}

.cal-now-dot {
  position: absolute;
  left: -4px;
  top: -4px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #ef4444;
  box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
}

/* --- Calendar Event Popover --- */
.cal-event-popover {
  position: fixed;
  z-index: 1000;
  width: 320px;
  max-width: calc(100vw - 32px);
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  padding: var(--space-5);
  animation: popoverFadeIn 0.15s ease-out;
}

@keyframes popoverFadeIn {
  from { opacity: 0; transform: translateY(4px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.cal-popover-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: var(--space-2);
  margin-bottom: var(--space-3);
}

.cal-popover-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--color-text-primary);
  line-height: var(--leading-tight);
  flex: 1;
}

.cal-popover-close {
  background: none;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 2px;
  border-radius: var(--radius-sm);
  flex-shrink: 0;
}

.cal-popover-close:hover {
  color: var(--color-text-primary);
  background: var(--color-accent-soft);
}

.cal-popover-row {
  display: flex;
  align-items: flex-start;
  gap: var(--space-2);
  padding: var(--space-1) 0;
  font-size: 13px;
  color: var(--color-text-secondary);
}

.cal-popover-row svg {
  flex-shrink: 0;
  margin-top: 1px;
  opacity: 0.7;
}

.cal-popover-description {
  font-size: 13px;
  color: var(--color-text-secondary);
  margin-top: var(--space-3);
  padding-top: var(--space-3);
  border-top: 1px solid var(--color-border);
  line-height: var(--leading-normal);
  max-height: 120px;
  overflow-y: auto;
  white-space: pre-wrap;
}

.cal-popover-calendar-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 10px;
  margin-top: var(--space-2);
}

/* --- Sub-tasks --- */
.subtask-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.subtask-item {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: 6px 0;
  border-bottom: 1px solid var(--color-border);
  font-size: 13px;
  color: var(--color-text-primary);
}

.subtask-item:last-child { border-bottom: none; }

.subtask-item input[type="checkbox"] {
  accent-color: var(--color-accent);
  width: 16px;
  height: 16px;
  cursor: pointer;
  flex-shrink: 0;
}

.subtask-item.completed .subtask-title {
  text-decoration: line-through;
  color: var(--color-text-tertiary);
}

.subtask-title { flex: 1; }

.subtask-delete {
  background: none;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 2px;
  border-radius: var(--radius-sm);
  opacity: 0;
  transition: opacity 0.15s;
}

.subtask-item:hover .subtask-delete { opacity: 1; }
.subtask-delete:hover { color: var(--color-danger); }

.subtask-progress-bar {
  width: 100%;
  height: 4px;
  background: var(--color-border);
  border-radius: 2px;
  margin-top: var(--space-2);
  overflow: hidden;
}

.subtask-progress-fill {
  height: 100%;
  background: var(--color-accent);
  border-radius: 2px;
  transition: width 0.25s ease;
}

.subtask-add-row {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-2);
}

.subtask-add-row input {
  flex: 1;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: 6px 10px;
  font-size: 13px;
  color: var(--color-text-primary);
}

.subtask-add-row input:focus {
  outline: none;
  border-color: var(--color-accent);
}

.subtask-add-row button {
  background: var(--color-accent-soft);
  border: none;
  color: var(--color-accent);
  border-radius: var(--radius-md);
  padding: 6px 10px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
}

.subtask-add-row button:hover { background: var(--color-accent); color: #fff; }

.task-subtask-badge, .task-file-badge {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  font-size: 11px;
  color: var(--color-text-tertiary);
  padding: 2px 6px;
  border-radius: 8px;
  background: var(--color-accent-soft);
}

.task-badges-row {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-1);
  flex-wrap: wrap;
}

/* --- File Attachments --- */
.file-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.file-item {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: 6px 0;
  border-bottom: 1px solid var(--color-border);
  font-size: 13px;
}

.file-item:last-child { border-bottom: none; }

.file-item svg { flex-shrink: 0; color: var(--color-text-tertiary); }

.file-item a {
  flex: 1;
  color: var(--color-accent);
  text-decoration: none;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.file-item a:hover { text-decoration: underline; }

.file-delete {
  background: none;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 2px;
  border-radius: var(--radius-sm);
  opacity: 0;
  transition: opacity 0.15s;
}

.file-item:hover .file-delete { opacity: 1; }
.file-delete:hover { color: var(--color-danger); }

.file-add-row {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-2);
}

.file-add-row input {
  flex: 1;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: 6px 10px;
  font-size: 13px;
  color: var(--color-text-primary);
}

.file-add-row input:focus { outline: none; border-color: var(--color-accent); }

.file-add-row button {
  background: var(--color-accent-soft);
  border: none;
  color: var(--color-accent);
  border-radius: var(--radius-md);
  padding: 6px 10px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
}

.file-add-row button:hover { background: var(--color-accent); color: #fff; }

/* Modal subtask/file list styling */
.modal-subtask-item, .modal-file-item {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: 4px 0;
  font-size: 13px;
  color: var(--color-text-primary);
}

.modal-subtask-item span, .modal-file-item span { flex: 1; }

.modal-subtask-item button, .modal-file-item button {
  background: none;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 2px;
}

.modal-subtask-item button:hover, .modal-file-item button:hover {
  color: var(--color-danger);
}

.calendar-allday-row {
  min-height: 30px;
  display: flex;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-1) var(--space-2);
  border-bottom: 1px solid var(--color-border);
}

.calendar-allday-event {
  font-size: 11px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}


/* ============================================================
   Component: Recurring Cards
   ============================================================ */
.recurring-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: var(--space-5);
  margin-bottom: var(--space-8);
}

.recurring-card {
  background-color: var(--color-surface);
  border-radius: var(--radius-xl);
  padding: var(--space-5);
  border: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
}

.recurring-card:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
  border-color: var(--color-border-hover);
}

.recurring-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-3);
}

.recurring-card-title {
  font-size: var(--text-card-title);
  font-weight: 600;
  color: var(--color-text-primary);
  flex: 1;
  min-width: 0;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.4;
}

.badge-active {
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: var(--radius-full);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  background-color: rgba(16, 185, 129, 0.12);
  color: var(--color-success);
}

.badge-paused {
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: var(--radius-full);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  background-color: rgba(245, 158, 11, 0.12);
  color: var(--color-warning);
}

.recurring-card-desc {
  font-size: 13px;
  color: var(--color-text-secondary);
  line-height: var(--leading-relaxed);
}

.recurring-schedule {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.recurring-schedule-text {
  font-size: 13px;
  color: var(--color-text-secondary);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.schedule-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.schedule-dot {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  background-color: var(--color-card-surface);
  color: var(--color-text-tertiary);
  transition: background-color var(--transition-fast), color var(--transition-fast);
}

.schedule-dot-active {
  background-color: var(--color-accent);
  color: #ffffff;
}

.recurring-card-footer {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding-top: var(--space-3);
  border-top: 1px solid var(--color-border);
}

.recurring-meta {
  display: flex;
  align-items: center;
  gap: var(--space-1);
  font-size: var(--text-badge);
  color: var(--color-text-secondary);
}
.recurring-goal-tag {
  display: flex;
  align-items: center;
  gap: var(--space-1);
  font-size: var(--text-badge);
  color: var(--color-accent);
  margin-left: auto;
}

/* ============================================================
   Component: Goals
   ============================================================ */
.goals-toolbar {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  margin-bottom: var(--space-5);
}

.goals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: var(--space-5);
}

.goal-card {
  background: var(--color-card-surface);
  border-radius: var(--radius-xl);
  border: 1px solid var(--color-border);
  border-left: 4px solid var(--priority-medium);
  padding: var(--space-5);
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
  animation: slideIn 0.3s var(--ease-default);
}

.goal-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--color-border-hover);
}

.goal-card.priority-high { border-left-color: var(--priority-high); }
.goal-card.priority-medium { border-left-color: var(--priority-medium); }
.goal-card.priority-low { border-left-color: var(--priority-low); }

.goal-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: var(--space-3);
  margin-bottom: var(--space-3);
}

.goal-card-title {
  font-size: var(--text-card-title);
  font-weight: 600;
  color: var(--color-text-primary);
  line-height: var(--leading-tight);
}

.goal-priority-badge {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  flex-shrink: 0;
}

.goal-priority-badge.high { background: rgba(239, 68, 68, 0.15); color: var(--priority-high); }
.goal-priority-badge.medium { background: rgba(245, 158, 11, 0.15); color: var(--priority-medium); }
.goal-priority-badge.low { background: rgba(16, 185, 129, 0.15); color: var(--priority-low); }

.goal-card-desc {
  font-size: var(--text-body);
  color: var(--color-text-secondary);
  line-height: var(--leading-relaxed);
  margin-bottom: var(--space-4);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.goal-progress-bar {
  width: 100%;
  height: 6px;
  background: var(--color-elevated-surface);
  border-radius: var(--radius-full);
  overflow: hidden;
  margin-bottom: var(--space-3);
}

.goal-progress-fill {
  height: 100%;
  border-radius: var(--radius-full);
  background: var(--color-accent-gradient);
  transition: width 0.5s var(--ease-default);
}

.goal-card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-3);
}

.goal-status-pill {
  font-size: var(--text-badge);
  font-weight: 500;
  padding: 2px 10px;
  border-radius: var(--radius-full);
}

.goal-status-pill.active { background: rgba(16, 185, 129, 0.15); color: var(--color-success); }
.goal-status-pill.paused { background: rgba(245, 158, 11, 0.15); color: var(--color-warning); }
.goal-status-pill.completed { background: rgba(59, 130, 246, 0.15); color: var(--color-info); }
.goal-status-pill.cancelled { background: rgba(239, 68, 68, 0.15); color: var(--color-danger); }

.goal-meta {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  font-size: var(--text-badge);
  color: var(--color-text-tertiary);
}

.goal-tasks-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: var(--text-badge);
  color: var(--color-text-secondary);
}

.goal-deadline {
  font-size: var(--text-badge);
  color: var(--color-text-secondary);
}

.goal-deadline.overdue {
  color: var(--color-danger);
  font-weight: 600;
}

.goal-progress-text {
  font-size: var(--text-badge);
  font-weight: 500;
  color: var(--color-text-secondary);
}

/* Goal side sheet extensions */
.goal-sheet-progress {
  margin: var(--space-4) 0;
}

.goal-sheet-progress-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: var(--space-2);
  font-size: var(--text-body);
  color: var(--color-text-secondary);
}

.goal-sheet-progress-bar {
  width: 100%;
  height: 8px;
  background: var(--color-elevated-surface);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.goal-sheet-progress-fill {
  height: 100%;
  border-radius: var(--radius-full);
  background: var(--color-accent-gradient);
  transition: width 0.5s var(--ease-default);
}

.goal-sheet-tasks {
  margin-top: var(--space-4);
}

.goal-sheet-tasks h4 {
  font-size: var(--text-body);
  font-weight: 600;
  color: var(--color-text-primary);
  margin-bottom: var(--space-3);
}

.goal-task-item {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  background: var(--color-elevated-surface);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-2);
  font-size: var(--text-body);
  color: var(--color-text-secondary);
}

.goal-task-status {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.goal-task-status.active { background: var(--color-success); }
.goal-task-status.paused { background: var(--color-warning); }
.goal-task-status.completed { background: var(--color-info); }

.goal-task-prompt {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.goal-task-next {
  font-size: var(--text-badge);
  color: var(--color-text-tertiary);
  flex-shrink: 0;
}

/* ============================================================
   Component: Activity Timeline
   ============================================================ */
.activity-timeline {
  position: relative;
  padding-left: 32px;
}

.activity-timeline::before {
  content: '';
  position: absolute;
  left: 12px;
  top: 0;
  bottom: 0;
  width: 2px;
  background-color: var(--color-border);
}

.activity-day-header {
  font-size: var(--text-body);
  font-weight: 600;
  color: var(--color-text-primary);
  margin-top: var(--space-6);
  margin-bottom: var(--space-3);
  position: relative;
}

.activity-day-header:first-child {
  margin-top: 0;
}

.activity-entry {
  display: flex;
  gap: var(--space-3);
  padding: var(--space-3);
  position: relative;
  border-radius: var(--radius-md);
  transition: background-color var(--transition-fast);
}

.activity-entry:hover {
  background-color: var(--color-accent-soft);
}

.activity-entry .activity-icon {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 13px;
  position: absolute;
  left: -26px;
  background-color: var(--color-surface);
  border: 2px solid var(--color-border);
  z-index: 1;
}

.activity-entry .activity-icon.completed {
  background-color: var(--color-success);
  border-color: var(--color-success);
  color: #ffffff;
}

.activity-entry .activity-icon.added {
  background-color: var(--color-accent);
  border-color: var(--color-accent);
  color: #ffffff;
}

.activity-entry .activity-icon.updated {
  background-color: var(--color-info);
  border-color: var(--color-info);
  color: #ffffff;
}

.activity-entry .activity-content {
  flex: 1;
  min-width: 0;
}

.activity-entry .activity-title {
  font-size: var(--text-body);
  color: var(--color-text-primary);
  line-height: var(--leading-normal);
  font-weight: 500;
}

.activity-entry .activity-details {
  font-size: 13px;
  color: var(--color-text-secondary);
  margin-top: 2px;
  line-height: var(--leading-normal);
}

.activity-entry .activity-time {
  font-size: var(--text-badge);
  color: var(--color-text-tertiary);
  white-space: nowrap;
  flex-shrink: 0;
}

/* ============================================================
   Component: Command Palette
   ============================================================ */
.command-palette {
  position: fixed;
  inset: 0;
  z-index: var(--z-command);
  background-color: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 15vh;
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition-normal);
}

.command-palette.open {
  opacity: 1;
  pointer-events: auto;
}

.command-palette-inner {
  max-width: 640px;
  width: 90%;
  background-color: var(--color-surface);
  border-radius: var(--radius-2xl);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--color-border);
  transform: scale(0.96) translateY(-10px);
  transition: transform var(--transition-normal);
}

.command-palette.open .command-palette-inner {
  transform: scale(1) translateY(0);
}

.command-palette-input-wrapper {
  display: flex;
  align-items: center;
  padding: var(--space-1) var(--space-5);
  border-bottom: 1px solid var(--color-border);
}

.command-palette-input-wrapper .search-icon {
  color: var(--color-text-tertiary);
  flex-shrink: 0;
  margin-right: var(--space-3);
}

.command-palette input {
  width: 100%;
  padding: var(--space-4) 0;
  border: none;
  background: transparent;
  font-size: var(--text-section-title);
  font-family: var(--font-sans);
  color: var(--color-text-primary);
  outline: none;
}

.command-palette input::placeholder {
  color: var(--color-text-tertiary);
}

.command-palette-results {
  max-height: 400px;
  overflow-y: auto;
  padding: var(--space-3) 0;
}

.command-palette-section-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--color-text-tertiary);
  padding: var(--space-2) var(--space-5) var(--space-1);
}

.command-palette-empty {
  padding: var(--space-6) var(--space-5);
  text-align: center;
  font-size: 13px;
  color: var(--color-text-tertiary);
}

.command-palette-result {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-2) var(--space-5);
  margin: 0 var(--space-2);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background-color var(--transition-fast);
}

.command-palette-result:hover,
.command-palette-result.selected {
  background-color: var(--color-accent-soft);
}

.command-palette-result .result-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-md);
  background-color: var(--color-card-surface);
  color: var(--color-text-secondary);
  flex-shrink: 0;
  font-size: 14px;
}

.command-palette-result .result-info {
  flex: 1;
  min-width: 0;
}

.command-palette-result .result-title {
  font-size: var(--text-body);
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.command-palette-result .result-description {
  font-size: var(--text-badge);
  color: var(--color-text-secondary);
}

.command-palette-result .result-shortcut {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  background-color: var(--color-card-surface);
  border: 1px solid var(--color-border);
  color: var(--color-text-tertiary);
  flex-shrink: 0;
}

.command-palette-footer {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-3) var(--space-5);
  border-top: 1px solid var(--color-border);
  font-size: 11px;
  color: var(--color-text-tertiary);
}

.command-palette-footer kbd {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 1px 5px;
  border-radius: 4px;
  background-color: var(--color-card-surface);
  border: 1px solid var(--color-border);
}

/* ============================================================
   Component: Notification Panel
   ============================================================ */
.notification-trigger,
.notification-wrapper {
  position: relative;
}

.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: var(--color-danger);
  color: #ffffff;
  font-size: 11px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: notification-pulse 2s ease-in-out infinite;
}

.notification-panel {
  position: absolute;
  top: 100%;
  right: 0;
  width: 360px;
  background-color: var(--color-surface);
  border-radius: var(--radius-xl);
  border: 1px solid var(--color-border);
  box-shadow: var(--shadow-lg);
  max-height: 400px;
  overflow-y: auto;
  z-index: var(--z-notification);
  margin-top: var(--space-2);
  opacity: 0;
  pointer-events: none;
  transform: translateY(-8px);
  transition: opacity var(--transition-normal), transform var(--transition-normal);
}

.notification-panel.open {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.notification-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-4) var(--space-4);
  border-bottom: 1px solid var(--color-border);
  position: sticky;
  top: 0;
  background-color: var(--color-surface);
  z-index: 1;
}

.notification-panel-header .panel-title {
  font-size: var(--text-card-title);
  font-weight: 600;
  color: var(--color-text-primary);
}

.notification-item {
  display: flex;
  gap: var(--space-3);
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--color-border);
  transition: background-color var(--transition-fast);
  cursor: pointer;
}

.notification-item:hover {
  background-color: var(--color-accent-soft);
}

.notification-item:last-child {
  border-bottom: none;
}

.notification-item.unread {
  background-color: var(--color-accent-soft);
}

.notification-item .notification-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background-color: var(--color-card-surface);
}

.notification-item .notification-content {
  flex: 1;
  min-width: 0;
}

.notification-item .notification-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text-primary);
  line-height: var(--leading-normal);
}

.notification-item .notification-detail {
  font-size: 12px;
  color: var(--color-text-tertiary);
  margin-top: 2px;
}

.notification-empty {
  padding: var(--space-5);
  text-align: center;
  font-size: 13px;
  color: var(--color-text-tertiary);
}

/* ============================================================
   Component: Keyboard Shortcuts Overlay
   ============================================================ */
.shortcuts-overlay {
  position: fixed;
  inset: 0;
  z-index: var(--z-command);
  background-color: rgba(0, 0, 0, 0.5);
  align-items: center;
  justify-content: center;
}

.shortcuts-panel {
  background-color: var(--color-surface);
  border-radius: var(--radius-2xl);
  padding: var(--space-8);
  max-width: 500px;
  width: 90%;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--color-border);
}

.shortcuts-panel .shortcuts-title {
  font-size: var(--text-section-title);
  font-weight: 700;
  color: var(--color-text-primary);
  margin-bottom: var(--space-5);
}

.shortcuts-section {
  margin-bottom: var(--space-5);
}

.shortcuts-section:last-child {
  margin-bottom: 0;
}

.shortcuts-section .section-label {
  font-size: var(--text-badge);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-tertiary);
  margin-bottom: var(--space-2);
}

.shortcut-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-2) 0;
  border-bottom: 1px dotted var(--color-border);
}

.shortcut-row:last-child {
  border-bottom: none;
}

.shortcut-row .shortcut-label {
  font-size: var(--text-body);
  color: var(--color-text-secondary);
}

.shortcut-key {
  background-color: var(--color-card-surface);
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: var(--text-badge);
  font-weight: 500;
  color: var(--color-text-secondary);
  border: 1px solid var(--color-border);
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.shortcut-row .shortcut-keys {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* ============================================================
   Component: Modal
   ============================================================ */
.modal {
  position: fixed;
  inset: 0;
  z-index: var(--z-modal);
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  padding: var(--space-5);
}

.modal.active {
  display: flex;
}

.modal-content {
  background-color: var(--color-surface);
  border-radius: var(--radius-2xl);
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--color-border);
  animation: slideInUp 300ms var(--ease-default);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-5) var(--space-6);
  border-bottom: 1px solid var(--color-border);
}

.modal-header .modal-title {
  font-size: var(--text-section-title);
  font-weight: 600;
  color: var(--color-text-primary);
}

.modal-body {
  padding: var(--space-5) var(--space-6);
}

.modal-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: var(--space-3);
  padding: var(--space-4) var(--space-6);
  border-top: 1px solid var(--color-border);
}

/* ============================================================
   Component: Buttons
   ============================================================ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: 10px 16px;
  border-radius: var(--radius-md);
  font-family: var(--font-sans);
  font-size: var(--text-body);
  font-weight: 500;
  cursor: pointer;
  transition: background-color var(--transition-fast), color var(--transition-fast),
    transform var(--transition-fast), box-shadow var(--transition-fast);
  border: none;
  outline: none;
  line-height: 1;
  white-space: nowrap;
  user-select: none;
}

.btn:focus-visible {
  box-shadow: 0 0 0 2px var(--color-base), 0 0 0 4px var(--color-accent-ring);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.btn-primary {
  background-color: var(--color-accent);
  color: #ffffff;
}

.btn-primary:hover {
  background-color: var(--color-accent-hover);
  transform: translateY(-1px);
  box-shadow: var(--shadow-accent);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background-color: var(--color-card-surface);
  color: var(--color-text-primary);
  border: 1px solid var(--color-border);
}

.btn-secondary:hover {
  background-color: var(--color-elevated-surface);
  border-color: var(--color-border-hover);
}

.btn-danger {
  background-color: var(--color-danger);
  color: #ffffff;
}

.btn-danger:hover {
  background-color: #dc2626;
  transform: translateY(-1px);
}

.btn-ghost {
  background: transparent;
  color: var(--color-text-secondary);
}

.btn-ghost:hover {
  background-color: var(--color-card-surface);
  color: var(--color-text-primary);
}

.btn-icon {
  width: 36px;
  height: 36px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-md);
  background: transparent;
  border: none;
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: background-color var(--transition-fast), color var(--transition-fast);
  flex-shrink: 0;
}

.btn-icon:hover {
  background-color: var(--color-card-surface);
  color: var(--color-text-primary);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.btn-lg {
  padding: 12px 24px;
  font-size: var(--text-card-title);
  border-radius: var(--radius-lg);
}

/* ============================================================
   Component: Form Inputs
   ============================================================ */
.form-group {
  margin-bottom: var(--space-4);
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text-secondary);
  margin-bottom: var(--space-2);
}

.form-input,
.form-textarea,
.form-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  background-color: var(--color-card-surface);
  font-family: var(--font-sans);
  font-size: var(--text-body);
  color: var(--color-text-primary);
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  outline: none;
}

.form-input::placeholder,
.form-textarea::placeholder {
  color: var(--color-text-tertiary);
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
  border-color: var(--color-accent);
  box-shadow: 0 0 0 3px var(--color-accent-ring);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
  line-height: var(--leading-relaxed);
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%238b8ba0' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  cursor: pointer;
}

.form-checkbox {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  cursor: pointer;
  font-size: var(--text-body);
  color: var(--color-text-primary);
}

.form-checkbox input[type="checkbox"] {
  width: 18px;
  height: 18px;
  border-radius: 4px;
  border: 1px solid var(--color-border);
  background-color: var(--color-card-surface);
  cursor: pointer;
  accent-color: var(--color-accent);
}

.form-hint {
  font-size: var(--text-badge);
  color: var(--color-text-tertiary);
  margin-top: var(--space-1);
}

.form-error {
  font-size: var(--text-badge);
  color: var(--color-danger);
  margin-top: var(--space-1);
}

.form-input.error,
.form-textarea.error,
.form-select.error {
  border-color: var(--color-danger);
}

.form-input.error:focus,
.form-textarea.error:focus,
.form-select.error:focus {
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
}

/* ============================================================
   Component: Toast Notifications
   ============================================================ */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: var(--z-command);
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
  pointer-events: none;
}

.toast {
  background-color: var(--color-surface);
  padding: var(--space-3) var(--space-5);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--color-border);
  display: flex;
  align-items: center;
  gap: var(--space-3);
  transform: translateY(100px);
  opacity: 0;
  transition: transform var(--transition-slow), opacity var(--transition-slow);
  pointer-events: auto;
  max-width: 400px;
}

.toast.show {
  transform: translateY(0);
  opacity: 1;
}

.toast .toast-icon {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast .toast-icon.success {
  color: var(--color-success);
}

.toast .toast-icon.error {
  color: var(--color-danger);
}

.toast .toast-icon.warning {
  color: var(--color-warning);
}

.toast .toast-icon.info {
  color: var(--color-info);
}

.toast .toast-message {
  font-size: 13px;
  color: var(--color-text-primary);
  flex: 1;
}

.toast .toast-close {
  background: none;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: color var(--transition-fast);
}

.toast .toast-close:hover {
  color: var(--color-text-primary);
}

/* ============================================================
   Component: Drag & Drop
   ============================================================ */
.drag-over {
  border: 2px dashed var(--color-accent) !important;
  background-color: var(--color-accent-soft) !important;
}

.dragging {
  opacity: 0.5;
  cursor: grabbing !important;
}

.drag-ghost {
  box-shadow: var(--shadow-lg);
  transform: rotate(2deg);
  opacity: 0.9;
}

/* ============================================================
   Component: Mobile Hamburger
   ============================================================ */
.hamburger-btn {
  display: none;
  width: 36px;
  height: 36px;
  align-items: center;
  justify-content: center;
  border: none;
  background: transparent;
  border-radius: var(--radius-md);
  color: var(--color-text-primary);
  cursor: pointer;
  z-index: calc(var(--z-sidebar) + 1);
}

.hamburger-btn:hover {
  background-color: var(--color-card-surface);
}

.hamburger-btn .hamburger-line {
  display: block;
  width: 20px;
  height: 2px;
  background-color: currentColor;
  border-radius: 1px;
  position: relative;
  transition: transform var(--transition-fast), opacity var(--transition-fast);
}

.hamburger-btn .hamburger-line::before,
.hamburger-btn .hamburger-line::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  background-color: currentColor;
  border-radius: 1px;
  left: 0;
  transition: transform var(--transition-fast);
}

.hamburger-btn .hamburger-line::before {
  top: -6px;
}

.hamburger-btn .hamburger-line::after {
  top: 6px;
}

.hamburger-btn.active .hamburger-line {
  background: transparent;
}

.hamburger-btn.active .hamburger-line::before {
  top: 0;
  transform: rotate(45deg);
}

.hamburger-btn.active .hamburger-line::after {
  top: 0;
  transform: rotate(-45deg);
}

/* ============================================================
   Utility: Loading / Skeleton
   ============================================================ */
.skeleton {
  background: linear-gradient(
    90deg,
    var(--color-card-surface) 25%,
    var(--color-elevated-surface) 50%,
    var(--color-card-surface) 75%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
  border-radius: var(--radius-md);
}

.skeleton-text {
  height: 14px;
  margin-bottom: var(--space-2);
}

.skeleton-text.sm {
  width: 40%;
}

.skeleton-text.md {
  width: 65%;
}

.skeleton-text.lg {
  width: 90%;
}

.skeleton-circle {
  border-radius: 50%;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--color-border);
  border-top-color: var(--color-accent);
  border-radius: 50%;
  animation: spin 600ms linear infinite;
}

/* ============================================================
   Utility: Badge / Pill
   ============================================================ */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: var(--text-badge);
  font-weight: 500;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  line-height: 1.4;
}

.badge-accent {
  background-color: var(--color-accent-soft);
  color: var(--color-accent);
}

.badge-success {
  background-color: rgba(16, 185, 129, 0.12);
  color: var(--color-success);
}

.badge-warning {
  background-color: rgba(245, 158, 11, 0.12);
  color: var(--color-warning);
}

.badge-danger {
  background-color: rgba(239, 68, 68, 0.12);
  color: var(--color-danger);
}

.badge-info {
  background-color: rgba(59, 130, 246, 0.12);
  color: var(--color-info);
}

.badge-neutral {
  background-color: var(--color-card-surface);
  color: var(--color-text-secondary);
}

/* ============================================================
   Utility: Empty States
   ============================================================ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--space-12) var(--space-8);
  text-align: center;
}

.empty-state .empty-icon {
  font-size: 48px;
  color: var(--color-text-tertiary);
  margin-bottom: var(--space-4);
  opacity: 0.5;
}

.empty-state .empty-title {
  font-size: var(--text-section-title);
  font-weight: 600;
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
}

.empty-state .empty-description {
  font-size: var(--text-body);
  color: var(--color-text-secondary);
  max-width: 360px;
  margin-bottom: var(--space-5);
}

/* ============================================================
   Utility: Divider
   ============================================================ */
.divider {
  height: 1px;
  background-color: var(--color-border);
  margin: var(--space-5) 0;
  border: none;
}

/* ============================================================
   Utility: Truncation & Overflow
   ============================================================ */
.truncate {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.line-clamp-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* ============================================================
   Utility: Flex helpers
   ============================================================ */
.flex { display: flex; }
.flex-col { flex-direction: column; }
.flex-1 { flex: 1; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.justify-center { justify-content: center; }
.gap-1 { gap: var(--space-1); }
.gap-2 { gap: var(--space-2); }
.gap-3 { gap: var(--space-3); }
.gap-4 { gap: var(--space-4); }
.gap-5 { gap: var(--space-5); }

/* ============================================================
   Utility: Visibility
   ============================================================ */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* --- Misc Missing Styles --- */
.activity-toolbar {
  margin-bottom: var(--space-4);
}

.filter-toggles {
  display: flex;
  gap: var(--space-2);
  flex-wrap: wrap;
}

.filter-toggles .btn.active {
  background-color: var(--color-accent);
  border-color: var(--color-accent);
  color: white;
}

.floating-help-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  color: var(--color-text-secondary);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
  transition: all var(--transition-fast);
}

.floating-help-btn:hover {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-accent);
}

.widget-icon {
  display: inline-flex;
}

/* ============================================================
   Responsive: Tablet & Mobile
   ============================================================ */
@media (max-width: 1024px) {
  .stat-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .kanban-board {
    grid-template-columns: repeat(2, 1fr);
  }

  .view-container {
    padding: var(--space-5) var(--space-6);
  }
}

@media (max-width: 768px) {
  .hamburger-btn {
    display: flex;
  }

  .sidebar {
    transform: translateX(-100%);
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .main-content {
    margin-left: 0;
  }

  .top-bar {
    padding: 0 var(--space-4);
  }

  .top-bar-search {
    display: none;
  }

  .view-container {
    padding: var(--space-4) var(--space-4);
  }

  .hero-greeting {
    font-size: 24px;
  }

  .stat-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
  }

  .stat-card {
    padding: var(--space-4);
  }

  .stat-value {
    font-size: 24px;
  }

  .kanban-board {
    grid-template-columns: 1fr;
  }

  .kanban-column {
    min-height: auto;
  }

  .side-sheet {
    width: 100%;
  }

  .notification-panel {
    width: calc(100vw - var(--space-8));
    right: calc(-1 * var(--space-4));
  }

  .command-palette-inner {
    width: 95%;
    margin-top: var(--space-4);
  }

  .modal-content {
    max-width: 100%;
    margin: var(--space-4);
    max-height: calc(100vh - var(--space-8));
  }

  .shortcuts-panel {
    padding: var(--space-5);
    max-width: 100%;
  }

  .recurring-grid {
    grid-template-columns: 1fr;
  }

  .calendar-header,
  .calendar-week {
    grid-template-columns: 40px repeat(7, 1fr);
  }

  .calendar-time-column {
    width: 40px;
  }

  .calendar-time-slot {
    font-size: 10px;
    padding-right: var(--space-1);
  }
}

@media (max-width: 480px) {
  .stat-grid {
    grid-template-columns: 1fr;
  }

  .top-bar-right .btn-icon:not(:first-child) {
    display: none;
  }

  .calendar-day-header .day-name {
    font-size: 9px;
  }

  .calendar-day-header .day-number {
    font-size: 13px;
    width: 26px;
    height: 26px;
  }
}

/* ============================================================
   Print Styles
   ============================================================ */
@media print {
  .sidebar,
  .top-bar,
  .command-palette,
  .toast-container,
  .notification-panel,
  .shortcuts-overlay,
  .hamburger-btn,
  .btn-icon {
    display: none !important;
  }

  .main-content {
    margin-left: 0 !important;
  }

  body {
    background: #fff;
    color: #000;
  }

  .stat-card,
  .task-card,
  .recurring-card,
  .kanban-column {
    box-shadow: none;
    border: 1px solid #ccc;
  }
}
    </style>
</head>
<body>
<div class="app-container">
  <!-- Hamburger button for mobile -->
  <button class="hamburger-btn" onclick="toggleSidebar()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="andy-face" id="andyFace">
        <div class="status-indicator" id="statusIndicator"></div>
        <div class="face-eyes">
          <div class="eye"></div>
          <div class="eye"></div>
        </div>
        <div class="face-mouth"></div>
      </div>
      <div>
        <div class="logo">Andy</div>
        <div class="logo-subtitle" id="statusText">Idle</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-item active" data-view="home" onclick="switchView('home')">
        <span class="nav-icon"></span>
        <span class="nav-label">Home</span>
        <span class="nav-badge"></span>
      </div>
      <div class="nav-item" data-view="goals" onclick="switchView('goals')">
        <span class="nav-icon"></span>
        <span class="nav-label">Goals</span>
        <span class="nav-badge" id="nav-goals-count"></span>
      </div>
      <div class="nav-item" data-view="tasks" onclick="switchView('tasks')">
        <span class="nav-icon"></span>
        <span class="nav-label">Tasks</span>
        <span class="nav-badge" id="nav-tasks-count"></span>
      </div>
      <div class="nav-item" data-view="calendar" onclick="switchView('calendar')">
        <span class="nav-icon"></span>
        <span class="nav-label">Calendar</span>
        <span class="nav-badge" id="nav-calendar-count"></span>
      </div>
      <div class="nav-item" data-view="recurring" onclick="switchView('recurring')">
        <span class="nav-icon"></span>
        <span class="nav-label">Recurring</span>
        <span class="nav-badge" id="nav-recurring-count"></span>
      </div>
      <div class="nav-item" data-view="activity" onclick="switchView('activity')">
        <span class="nav-icon"></span>
        <span class="nav-label">Activity</span>
        <span class="nav-badge"></span>
      </div>
    </nav>

    <div class="sidebar-widgets">
      <div class="sidebar-widget" id="sidebarStatsWidget">
        <div class="sidebar-stat-row">
          <span class="sidebar-stat-label">Tasks</span>
          <span class="sidebar-stat-value" id="sidebarTaskCount">0</span>
        </div>
        <div class="sidebar-stat-row">
          <span class="sidebar-stat-label">Goals</span>
          <span class="sidebar-stat-value" id="sidebarGoalCount">0</span>
        </div>
        <div class="sidebar-stat-row">
          <span class="sidebar-stat-label">Today's Events</span>
          <span class="sidebar-stat-value" id="sidebarEventCount">0</span>
        </div>
        <div class="sidebar-stat-row">
          <span class="sidebar-stat-label">Calendar Sync</span>
          <span class="sidebar-stat-value" id="calendarSync">--</span>
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn-icon theme-toggle" id="themeToggleBtn" onclick="cycleTheme()" title="Toggle theme">
        <span id="themeIcon"></span>
      </button>
      <button class="btn-icon" onclick="showShortcuts()" title="Keyboard shortcuts">?</button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-left">
        <h2 class="view-title" id="viewTitle">Home</h2>
      </div>
      <div class="top-bar-center">
        <div class="top-bar-search" onclick="openCommandPalette()">
          <span id="searchIcon"></span>
          <span>Search or jump to...</span>
          <kbd>&#8984;K</kbd>
        </div>
      </div>
      <div class="top-bar-right">
        <div class="notification-wrapper">
          <button class="btn-icon" id="notificationBtn" onclick="toggleNotifications()">
            <span id="bellIcon"></span>
            <span class="notification-badge" id="notificationBadge" style="display:none">0</span>
          </button>
          <div class="notification-panel" id="notificationPanel">
            <div class="notification-panel-header">
              <span class="panel-title">Notifications</span>
            </div>
            <div id="notificationList"></div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="openNewTaskModal()">
          <span id="plusIcon"></span> New Task
        </button>
      </div>
    </div>

    <!-- HOME VIEW -->
    <div class="view-container" id="homeView">
      <div class="home-greeting">
        <h1 id="greetingText">Good morning, Naveen</h1>
        <p id="greetingDate"></p>
      </div>

      <div class="stats-grid">
        <div class="stat-card" onclick="switchView('goals')">
          <div class="stat-icon" style="color:#6366f1"></div>
          <div class="stat-value" id="statActiveGoals">0</div>
          <div class="stat-label">Active Goals</div>
        </div>
        <div class="stat-card" onclick="switchView('tasks')">
          <div class="stat-icon" style="color:#8b5cf6"></div>
          <div class="stat-value" id="statActiveTasks">0</div>
          <div class="stat-label">Active Tasks</div>
        </div>
        <div class="stat-card" onclick="switchView('calendar')">
          <div class="stat-icon" style="color:#3b82f6"></div>
          <div class="stat-value" id="statTodayEvents">0</div>
          <div class="stat-label">Today's Events</div>
        </div>
        <div class="stat-card" onclick="switchView('recurring')">
          <div class="stat-icon" style="color:#10b981"></div>
          <div class="stat-value" id="statRecurring">0</div>
          <div class="stat-label">Recurring Tasks</div>
        </div>
      </div>

      <div class="home-sections">
        <div class="home-main">
          <section class="home-section" id="homeGoalsSection" style="display:none">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: var(--space-3);">
              <h3 class="section-title" style="margin-bottom:0">Active Goals</h3>
              <a href="#" onclick="event.preventDefault();switchView('goals')" style="font-size:var(--text-badge)">View all</a>
            </div>
            <div id="homeGoals"></div>
          </section>
          <section class="home-section">
            <h3 class="section-title">Today's Agenda</h3>
            <div id="todayAgenda" class="agenda-timeline"></div>
          </section>
          <section class="home-section">
            <h3 class="section-title">Active Work</h3>
            <div id="activeWork"></div>
          </section>
        </div>
        <div class="home-aside">
          <section class="home-section">
            <h3 class="section-title">Up Next</h3>
            <div id="upNext"></div>
          </section>
          <section class="home-section">
            <h3 class="section-title">Upcoming Deadlines</h3>
            <div id="upcomingDeadlines"></div>
          </section>
        </div>
      </div>
    </div>

    <!-- TASKS VIEW -->
    <div class="view-container" id="tasksView" style="display:none">
      <div class="tasks-toolbar">
        <input type="text" class="task-search-input" id="taskSearchInput" placeholder="Search tasks..." oninput="renderTasksView()">
        <select class="task-filter-select" id="taskSortBy" onchange="renderTasksView()">
          <option value="newest">Newest</option>
          <option value="priority">Priority</option>
          <option value="deadline">Deadline</option>
        </select>
      </div>

      <div class="kanban-board">
        <div class="kanban-column">
          <div class="kanban-column-header">
            <span class="column-dot" style="background:#6366f1"></span>
            <span class="column-label">Backlog</span>
            <span class="column-count" id="backlog-count">0</span>
          </div>
          <div class="kanban-cards" id="backlog" data-status="backlog"></div>
        </div>
        <div class="kanban-column">
          <div class="kanban-column-header">
            <span class="column-dot" style="background:#f59e0b"></span>
            <span class="column-label">In Progress</span>
            <span class="column-count" id="progress-count">0</span>
          </div>
          <div class="kanban-cards" id="progress" data-status="progress"></div>
        </div>
        <div class="kanban-column">
          <div class="kanban-column-header">
            <span class="column-dot" style="background:#10b981"></span>
            <span class="column-label">Completed</span>
            <span class="column-count" id="completed-count">0</span>
          </div>
          <div class="kanban-cards" id="completed" data-status="completed"></div>
        </div>
      </div>
    </div>

    <!-- GOALS VIEW -->
    <div class="view-container" id="goalsView" style="display:none">
      <div class="goals-toolbar">
        <select class="task-filter-select" id="goalStatusFilter" onchange="renderGoalsView()">
          <option value="all">All Goals</option>
          <option value="active">Active</option>
          <option value="paused">Paused</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button class="btn btn-primary" onclick="openNewGoalModal()" style="margin-left:auto">
          <span data-inject-icon="plus" data-icon-size="16"></span> New Goal
        </button>
      </div>
      <div class="goals-grid" id="goalsGrid"></div>
    </div>

    <!-- CALENDAR VIEW -->
    <div class="view-container" id="calendarView" style="display:none">
      <div class="calendar-toolbar">
        <div class="calendar-nav">
          <button class="btn-icon" onclick="calendarPrev()"><span id="chevronLeftIcon"></span></button>
          <button class="btn btn-secondary" onclick="calendarToday()">Today</button>
          <button class="btn-icon" onclick="calendarNext()"><span id="chevronRightIcon"></span></button>
          <span class="calendar-range" id="calendarRange"></span>
        </div>
        <div class="calendar-view-toggle">
          <button class="btn btn-secondary active" id="weekViewBtn" onclick="setCalendarMode('week')">Week</button>
          <button class="btn btn-secondary" id="dayViewBtn" onclick="setCalendarMode('day')">Day</button>
        </div>
      </div>
      <div class="calendar-grid-wrapper">
        <div id="calendarGrid"></div>
      </div>
    </div>

    <!-- RECURRING VIEW -->
    <div class="view-container" id="recurringView" style="display:none">
      <div class="recurring-grid" id="recurringGrid"></div>
    </div>

    <!-- ACTIVITY VIEW -->
    <div class="view-container" id="activityView" style="display:none">
      <div class="activity-toolbar">
        <div class="filter-toggles" id="activityFilters">
          <button class="btn btn-secondary active" data-filter="all" onclick="filterActivity('all')">All</button>
          <button class="btn btn-secondary" data-filter="task" onclick="filterActivity('task')">Tasks</button>
          <button class="btn btn-secondary" data-filter="call" onclick="filterActivity('call')">Calls</button>
          <button class="btn btn-secondary" data-filter="recurring" onclick="filterActivity('recurring')">Recurring</button>
        </div>
      </div>
      <div class="activity-timeline" id="activityTimeline"></div>
    </div>
  </main>
</div>

<!-- Side Sheet for Task Detail -->
<div class="side-sheet-overlay" id="sideSheetOverlay" onclick="closeSideSheet()"></div>
<div class="side-sheet" id="sideSheet">
  <div class="side-sheet-header">
    <h3 id="sideSheetTitle"></h3>
    <div class="side-sheet-actions">
      <button class="btn-icon" onclick="editTaskFromSheet()" title="Edit"><span id="editIconSheet"></span></button>
      <button class="btn-icon" onclick="closeSideSheet()" title="Close"><span id="closeIconSheet"></span></button>
    </div>
  </div>
  <div class="side-sheet-body">
    <div class="sheet-field">
      <label>Status</label>
      <span id="sheetStatus"></span>
    </div>
    <div class="sheet-field">
      <label>Priority</label>
      <span id="sheetPriority"></span>
    </div>
    <div class="sheet-field">
      <label>Deadline</label>
      <span id="sheetDeadline"></span>
    </div>
    <div class="sheet-field">
      <label>Created</label>
      <span id="sheetCreated"></span>
    </div>
    <div class="sheet-field description">
      <label>Description</label>
      <p id="sheetDescription"></p>
    </div>
    <div id="sheetSubtasks"></div>
    <div id="sheetFiles"></div>
  </div>
</div>

<!-- Task Modal (New/Edit) -->
<div class="modal" id="taskModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">New Task</h2>
      <button class="btn-icon" onclick="closeTaskModal()"><span id="closeIconModal"></span></button>
    </div>
    <form id="taskForm" onsubmit="return saveTask(event)">
      <div class="modal-body">
        <input type="hidden" id="taskId">
        <div class="form-group">
          <label class="form-label">Title *</label>
          <input type="text" class="form-input" id="taskTitle" required placeholder="What needs to be done?">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="taskDescription" rows="3" placeholder="Add more details..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-select" id="taskPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="taskStatus">
              <option value="backlog" selected>Backlog</option>
              <option value="progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Deadline</label>
          <input type="date" class="form-input" id="taskDeadline">
        </div>
        <div class="form-group">
          <label class="form-label">Sub-tasks</label>
          <div id="modalSubtasksList"></div>
          <div class="subtask-add-row">
            <input type="text" id="modalSubtaskInput" placeholder="Add a sub-task..." onkeydown="if(event.key==='Enter'){event.preventDefault();addSubtaskInModal();}">
            <button type="button" onclick="addSubtaskInModal()">Add</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">File Attachments</label>
          <div id="modalFilesList"></div>
          <div class="file-add-row">
            <input type="text" id="modalFileName" placeholder="File name">
            <input type="text" id="modalFilePath" placeholder="File path or URL">
            <button type="button" onclick="addFileInModal()">Add</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Task</button>
      </div>
    </form>
  </div>
</div>

<!-- Goal Modal -->
<div class="modal" id="goalModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="goalModalTitle">New Goal</h2>
      <button class="btn-icon" onclick="closeGoalModal()"><span data-inject-icon="x" data-icon-size="20"></span></button>
    </div>
    <form id="goalForm" onsubmit="return saveGoal(event)">
      <div class="modal-body">
        <input type="hidden" id="goalId">
        <div class="form-group">
          <label class="form-label">Title *</label>
          <input type="text" class="form-input" id="goalTitle" required placeholder="What do you want to achieve?">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="goalDescription" rows="3" placeholder="Describe the goal in more detail..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-select" id="goalPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Deadline</label>
            <input type="date" class="form-input" id="goalDeadline">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Goal</button>
      </div>
    </form>
  </div>
</div>

<!-- Command Palette -->
<div class="command-palette" id="commandPalette" onclick="if(event.target===this)closeCommandPalette()">
  <div class="command-palette-inner">
    <div class="command-palette-input-wrapper">
      <span class="search-icon" id="searchIconPalette"></span>
      <input type="text" id="commandInput" placeholder="Search tasks, events, recurring..." oninput="handleCommandSearch()" autocomplete="off">
    </div>
    <div class="command-palette-results" id="commandResults"></div>
  </div>
</div>

<!-- Shortcuts Help Overlay -->
<div class="shortcuts-overlay" id="shortcutsOverlay" style="display:none" onclick="if(event.target===this)closeShortcuts()">
  <div class="shortcuts-panel">
    <h3>Keyboard Shortcuts</h3>
    <div class="shortcut-row"><span>Command Palette</span><kbd>&#8984;K</kbd></div>
    <div class="shortcut-row"><span>New Task</span><kbd>&#8984;N</kbd></div>
    <div class="shortcut-row"><span>Home</span><kbd>1</kbd></div>
    <div class="shortcut-row"><span>Tasks</span><kbd>2</kbd></div>
    <div class="shortcut-row"><span>Calendar</span><kbd>3</kbd></div>
    <div class="shortcut-row"><span>Recurring</span><kbd>4</kbd></div>
    <div class="shortcut-row"><span>Activity</span><kbd>5</kbd></div>
    <div class="shortcut-row"><span>Toggle Theme</span><kbd>D</kbd></div>
    <div class="shortcut-row"><span>Close / Dismiss</span><kbd>Esc</kbd></div>
    <div class="shortcut-row"><span>This Help</span><kbd>?</kbd></div>
  </div>
</div>

<!-- Floating Help Button -->
<button class="floating-help-btn" onclick="showShortcuts()" title="Keyboard shortcuts (?)">?</button>
<script>
// ============================================================
// DASHBOARD JS - PART 1
// SVG Icon System, App State, Theme, Icon Injection,
// Date/Time Helpers, Animated Counter
// ============================================================

// ------------------------------------------------------------
// 1. SVG ICON SYSTEM
// Returns inline SVG strings for consistent iconography.
// All icons use stroke-based rendering with currentColor.
// ------------------------------------------------------------

function getIcon(name, size = 20) {
  const icons = {
    // House outline
    home: `<path d="M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/><polyline points="9 21 9 14 15 14 15 21"/>`,

    // Clipboard with checklist
    tasks: `<path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="2" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/>`,

    // Calendar outline
    calendar: `<rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>`,

    // Refresh/cycle arrows
    recurring: `<polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"/>`,

    // Activity/pulse line
    activity: `<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>`,

    // Magnifying glass
    search: `<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>`,

    // Plus sign
    plus: `<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>`,

    // Pencil
    edit: `<path d="M17 3a2.828 2.828 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>`,

    // Trash can
    trash: `<polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>`,

    // Checkmark in circle
    'check-circle': `<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>`,

    // Clock face
    clock: `<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`,

    // Bell
    bell: `<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>`,

    // Sun (light mode)
    sun: `<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>`,

    // Moon (dark mode)
    moon: `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`,

    // Left chevron
    'chevron-left': `<polyline points="15 18 9 12 15 6"/>`,

    // Right chevron
    'chevron-right': `<polyline points="9 6 15 12 9 18"/>`,

    // Phone
    phone: `<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>`,

    // Chat bubble
    message: `<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z"/>`,

    // Flag/priority
    flag: `<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>`,

    // 6-dot drag handle
    grip: `<circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>`,

    // Close X
    x: `<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>`,

    // Funnel/filter
    filter: `<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>`,

    // Up arrow
    'arrow-up': `<line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>`,

    // Star
    star: `<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>`,

    // Exclamation in circle (overdue)
    'alert-circle': `<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>`,

    // Computer screen (auto theme)
    monitor: `<rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>`,

    // File document
    file: `<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>`,

    // Paperclip
    paperclip: `<path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>`,

    // Check square (subtask)
    'check-square': `<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>`,

    // External link
    'external-link': `<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>`,

    // Map pin (location)
    'map-pin': `<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>`,

    // Target/crosshair (goals)
    goals: `<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>`,
    target: `<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>`,

    // List
    list: `<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>`,
  };

  const svgContent = icons[name] || '';
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${svgContent}</svg>`;
}


// ------------------------------------------------------------
// 2. APP STATE
// Central state object for the entire dashboard application.
// ------------------------------------------------------------

const AppState = {
  tasks: [],                  // All tasks from the task system
  recurringTasks: [],         // Recurring task definitions
  allCalendarEvents: [],      // All events from cache (14 days)
  todayEvents: [],            // Filtered for today only
  activityFeed: [],           // Recent activity entries
  goals: [],                  // Goals with linked tasks (merged)
  // goals loaded directly from API (SQLite)
  notifications: [],          // Notification items
  currentView: 'home',       // Active view: 'home' | 'tasks' | 'calendar' | 'recurring' | 'activity' | 'goals'
  theme: localStorage.getItem('andy_theme') || 'auto',  // 'auto' | 'light' | 'dark'
  searchQuery: '',            // Current search/filter query
  selectedTask: null,         // Currently selected task for detail view
  calendarMode: 'week',      // Calendar display mode: 'week' | 'day'
  calendarWeekStart: null,    // Date object for start of displayed week
  commandPaletteOpen: false,  // Whether command palette is visible
  commandSelectedIndex: 0,    // Currently highlighted command in palette
  activityFilter: 'all',     // Activity feed filter: 'all' | 'tasks' | 'calendar' | 'messages'
};


// ------------------------------------------------------------
// 3. THEME SYSTEM
// Supports auto (follows OS), light, and dark modes.
// Persists preference to localStorage.
// ------------------------------------------------------------

function applyTheme() {
  const root = document.documentElement;
  let effectiveTheme;

  if (AppState.theme === 'auto') {
    // Detect system preference
    effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    root.removeAttribute('data-theme');
    root.setAttribute('data-theme', effectiveTheme);
  } else {
    // Manual override
    effectiveTheme = AppState.theme;
    root.setAttribute('data-theme', effectiveTheme);
  }

  // Update the theme toggle button icon
  const themeIcon = document.getElementById('themeIcon');
  if (themeIcon) {
    let iconName;
    if (AppState.theme === 'auto') iconName = 'monitor';
    else if (AppState.theme === 'light') iconName = 'sun';
    else iconName = 'moon';

    themeIcon.innerHTML = getIcon(iconName, 18);
    const themeBtn = document.getElementById('themeToggleBtn');
    if (themeBtn) themeBtn.title = `Theme: ${AppState.theme} (click to cycle)`;
  }

  // Persist preference
  localStorage.setItem('andy_theme', AppState.theme);
}

function cycleTheme() {
  // Cycle through: auto -> light -> dark -> auto
  const order = ['auto', 'light', 'dark'];
  const currentIndex = order.indexOf(AppState.theme);
  AppState.theme = order[(currentIndex + 1) % order.length];
  applyTheme();
}

// Listen for system theme changes when in auto mode
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  if (AppState.theme === 'auto') applyTheme();
});


// ------------------------------------------------------------
// 4. ICON INJECTION
// Replaces placeholder <span> elements with SVG icons
// throughout the dashboard on initial load.
// ------------------------------------------------------------

function injectIcons() {
  // --- Navigation items ---
  // Each nav item has a data-view attribute that maps to an icon name
  document.querySelectorAll('.nav-item').forEach(item => {
    const view = item.getAttribute('data-view');
    const iconSpan = item.querySelector('.nav-icon');
    if (iconSpan && view) {
      iconSpan.innerHTML = getIcon(view, 20);
    }
  });

  // --- Stat cards ---
  // Each stat card has a data-icon attribute specifying which icon to use
  document.querySelectorAll('.stat-card .stat-icon').forEach(iconEl => {
    const iconName = iconEl.getAttribute('data-icon');
    if (iconName) {
      iconEl.innerHTML = getIcon(iconName, 22);
    }
  });

  // --- Header actions ---
  // Bell / notification icon
  const bellIcon = document.getElementById('bellIcon');
  if (bellIcon) bellIcon.innerHTML = getIcon('bell', 20);

  // Search icon in top bar trigger
  const searchIcon = document.getElementById('searchIcon');
  if (searchIcon) searchIcon.innerHTML = getIcon('search', 16);

  // Search icon in command palette
  const searchIconPalette = document.getElementById('searchIconPalette');
  if (searchIconPalette) searchIconPalette.innerHTML = getIcon('search', 18);

  // Add/plus button icon
  const plusIcon = document.getElementById('plusIcon');
  if (plusIcon) plusIcon.innerHTML = getIcon('plus', 20);

  // Side sheet & modal icons
  const editIconSheet = document.getElementById('editIconSheet');
  if (editIconSheet) editIconSheet.innerHTML = getIcon('edit', 18);
  const closeIconSheet = document.getElementById('closeIconSheet');
  if (closeIconSheet) closeIconSheet.innerHTML = getIcon('x', 18);
  const closeIconModal = document.getElementById('closeIconModal');
  if (closeIconModal) closeIconModal.innerHTML = getIcon('x', 18);

  // --- Theme toggle ---
  applyTheme(); // This also sets the theme icon

  // --- Calendar navigation arrows ---
  const calPrev = document.getElementById('cal-prev-icon');
  if (calPrev) calPrev.innerHTML = getIcon('chevron-left', 18);

  const calNext = document.getElementById('cal-next-icon');
  if (calNext) calNext.innerHTML = getIcon('chevron-right', 18);

  // --- Filter icon ---
  const filterIcon = document.getElementById('filter-icon');
  if (filterIcon) filterIcon.innerHTML = getIcon('filter', 18);

  // --- Any generic icon placeholders with data-icon attribute ---
  document.querySelectorAll('[data-inject-icon]').forEach(el => {
    const iconName = el.getAttribute('data-inject-icon');
    const iconSize = parseInt(el.getAttribute('data-icon-size')) || 20;
    if (iconName) {
      el.innerHTML = getIcon(iconName, iconSize);
    }
  });
}


// ------------------------------------------------------------
// 5. DATE / TIME HELPERS
// All date functions use IST (Asia/Kolkata) timezone.
// ------------------------------------------------------------

/**
 * Parse a date string, handling the +0530 timezone format
 * that Safari cannot natively parse (needs +05:30).
 */
function parseDate(dateStr) {
  if (!dateStr) return null;
  // Convert +0530 to +05:30 for Safari compatibility
  return new Date(dateStr.replace(/([+-]\d{2})(\d{2})$/, '$1:$2'));
}

/**
 * Get today's date in IST as YYYY-MM-DD string.
 */
function getISTDate() {
  return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });
}

/**
 * Format a Date object as "2:30 PM" in IST.
 */
function formatTime(date) {
  return date.toLocaleTimeString('en-IN', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Asia/Kolkata'
  });
}

/**
 * Format a Date object as "Feb 11, 2026" in IST.
 */
function formatDate(date) {
  return date.toLocaleDateString('en-IN', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    timeZone: 'Asia/Kolkata'
  });
}

/**
 * Format a Date as a human-friendly relative time string.
 * "just now", "5m ago", "2h ago", "yesterday", "3d ago", or "Feb 10"
 */
function formatRelativeTime(date) {
  const now = new Date();
  const diff = now - date;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days === 1) return 'yesterday';
  if (days < 7) return `${days}d ago`;
  return formatDate(date);
}

/**
 * Return a time-of-day greeting based on IST hour.
 */
function getGreeting() {
  const hour = new Date().toLocaleString('en-IN', {
    hour: 'numeric',
    hour12: false,
    timeZone: 'Asia/Kolkata'
  });
  const h = parseInt(hour);
  if (h < 12) return 'Good morning';
  if (h < 17) return 'Good afternoon';
  return 'Good evening';
}

/**
 * Get the Monday of the week containing the given date.
 * Weeks start on Monday.
 */
function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  // Adjust so Monday = 0: if Sunday (0), go back 6 days; otherwise go back (day - 1) days
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  d.setDate(diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

/**
 * Check if two Date objects represent the same calendar day.
 */
function isSameDay(d1, d2) {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
}

/**
 * Return a color for a given calendar name.
 * Falls back to indigo for unknown calendars.
 */
function getCalendarColor(calendarName) {
  const colors = {
    'Important Stuff': '#6366f1',   // Indigo
    'Daily Routine': '#10b981',     // Emerald
    'Work': '#3b82f6',              // Blue
    'Birthdays': '#ec4899',         // Pink
    'India Holidays': '#f59e0b'     // Amber
  };
  return colors[calendarName] || '#6366f1';
}


// ------------------------------------------------------------
// 6. ANIMATED COUNTER
// Smoothly animates a number element from its current value
// to a target value using ease-out cubic easing.
// ------------------------------------------------------------

function animateCounter(elementId, targetValue) {
  const el = document.getElementById(elementId);
  if (!el) return;

  const current = parseInt(el.textContent) || 0;
  // Skip animation if already at target
  if (current === targetValue) return;

  const duration = 600; // milliseconds
  const start = performance.now();

  function update(now) {
    const elapsed = now - start;
    const progress = Math.min(elapsed / duration, 1);
    // Ease-out cubic for a smooth deceleration
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(current + (targetValue - current) * eased);
    if (progress < 1) requestAnimationFrame(update);
  }

  requestAnimationFrame(update);
}
// ============================================================
// Data Loading
// ============================================================

async function loadTasks() {
  try {
    const res = await fetch('tasks.json?t=' + Date.now());
    if (res.ok) {
      AppState.tasks = await res.json();
      localStorage.setItem('andy_tasks', JSON.stringify(AppState.tasks));
    }
  } catch(e) {
    const stored = localStorage.getItem('andy_tasks');
    if (stored) AppState.tasks = JSON.parse(stored);
  }
}

async function loadCalendarEvents() {
  try {
    const res = await fetch('apple-calendar-cache.json?t=' + Date.now());
    if (res.ok) {
      const data = await res.json();
      AppState.calendarLastSync = data.lastSync;
      AppState.allCalendarEvents = (data.events || []).map(e => ({
        ...e,
        _start: parseDate(e.startDate),
        _end: parseDate(e.endDate),
        _color: getCalendarColor(e.calendar)
      })).filter(e => e._start && !isNaN(e._start));

      // Filter today's events
      const istDate = getISTDate();
      const todayStart = new Date(istDate + 'T00:00:00+05:30');
      const todayEnd = new Date(istDate + 'T23:59:59+05:30');
      AppState.todayEvents = AppState.allCalendarEvents
        .filter(e => e._start <= todayEnd && (e._end || e._start) >= todayStart)
        .sort((a, b) => a._start - b._start);
    }
  } catch(e) {
    console.error('Calendar load error:', e);
  }
}

async function loadRecurringTasks() {
  try {
    const res = await fetch('recurring-tasks.json?t=' + Date.now());
    if (res.ok) {
      AppState.recurringTasks = await res.json();
    }
  } catch(e) {
    console.error('Recurring tasks error:', e);
  }
}

async function loadActivityFeed() {
  try {
    const res = await fetch('activity-feed.json?t=' + Date.now());
    if (res.ok) {
      AppState.activityFeed = await res.json();
    }
  } catch(e) {
    // activity feed is optional, might not exist yet
    AppState.activityFeed = [];
  }
}

async function loadGoals() {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 3000);
    const res = await fetch('http://localhost:3001/goals', { signal: controller.signal });
    clearTimeout(timeout);
    if (res.ok) {
      AppState.goals = await res.json();
    }
  } catch(e) {
    // API not available  fall back to static goals.json
    try {
      const fallback = await fetch('goals.json?t=' + Date.now());
      if (fallback.ok) {
        AppState.goals = await fallback.json();
      }
    } catch(e2) {
      AppState.goals = AppState.goals || [];
    }
  }
}

function computeNotifications() {
  const notifs = [];
  const now = new Date();

  // Overdue tasks (past deadline, not completed)
  AppState.tasks.filter(t => t.deadline && t.status !== 'completed').forEach(t => {
    const dl = new Date(t.deadline);
    if (dl < now) {
      notifs.push({ type: 'overdue', title: t.title, detail: 'Overdue since ' + formatDate(dl), icon: 'alert-circle', color: '#ef4444', action: 'task', taskId: t.id });
    }
  });

  // Tasks due today or tomorrow
  const todayStr = getISTDate();
  const tomorrow = new Date(todayStr + 'T00:00:00+05:30');
  tomorrow.setDate(tomorrow.getDate() + 1);
  const dayAfter = new Date(tomorrow);
  dayAfter.setDate(dayAfter.getDate() + 1);

  AppState.tasks.filter(t => t.deadline && t.status !== 'completed').forEach(t => {
    const dl = new Date(t.deadline);
    if (dl >= now && dl < dayAfter) {
      const label = dl < tomorrow ? 'Due today' : 'Due tomorrow';
      notifs.push({ type: 'due-soon', title: t.title, detail: label, icon: 'clock', color: '#f59e0b', action: 'task', taskId: t.id });
    }
  });

  // Recurring tasks running within 1 hour
  AppState.recurringTasks.filter(t => t.status === 'active' && t.next_run).forEach(t => {
    const next = new Date(t.next_run);
    const diff = next - now;
    if (diff > 0 && diff < 3600000) {
      const recurTitle = t.prompt.split('\n')[0].replace(/^[\d.)\-:\s]+/, '').trim().slice(0, 80);
      notifs.push({ type: 'recurring-soon', title: recurTitle, detail: 'Runs in ' + Math.round(diff/60000) + ' min', icon: 'recurring', color: '#8b5cf6', action: 'recurring' });
    }
  });

  // Calendar events starting within 30 minutes
  AppState.todayEvents.filter(e => !e.allDay).forEach(e => {
    const diff = e._start - now;
    if (diff > 0 && diff < 1800000) {
      notifs.push({ type: 'event-soon', title: e.summary, detail: 'Starts in ' + Math.round(diff/60000) + ' min', icon: 'calendar', color: '#3b82f6', action: 'calendar' });
    }
  });

  AppState.notifications = notifs;
}

async function loadAgentStatus() {
  try {
    const res = await fetch('agent-status.json?t=' + Date.now());
    if (res.ok) {
      const data = await res.json();
      const indicator = document.getElementById('statusIndicator');
      const text = document.getElementById('statusText');
      if (data.status === 'working') {
        if (indicator) indicator.classList.add('working');
        if (text) text.textContent = 'Working...';
      } else {
        if (indicator) indicator.classList.remove('working');
        if (text) text.textContent = 'Idle';
      }
    }
  } catch(e) {
    // agent-status.json may not exist yet
  }
}

async function refreshAllData() {
  await Promise.all([
    loadTasks(),
    loadRecurringTasks(),
    loadCalendarEvents(),
    loadActivityFeed(),
    loadAgentStatus(),
    loadGoals()
  ]);
  computeNotifications();
  updateNavBadges();
  renderCurrentView();
  renderSidebarWidgets();
  renderNotificationBadge();
}

function updateNavBadges() {
  const taskBadge = document.getElementById('nav-tasks-count');
  if (taskBadge) {
    const count = AppState.tasks.filter(t => t.status === 'backlog' || t.status === 'progress').length;
    taskBadge.textContent = count > 0 ? count : '';
  }
  const goalBadge = document.getElementById('nav-goals-count');
  if (goalBadge) {
    const count = (AppState.goals || []).filter(g => g.status === 'active').length;
    goalBadge.textContent = count > 0 ? count : '';
  }
  const calBadge = document.getElementById('nav-calendar-count');
  if (calBadge) {
    const count = AppState.todayEvents.length;
    calBadge.textContent = count > 0 ? count : '';
  }
  const recurBadge = document.getElementById('nav-recurring-count');
  if (recurBadge) {
    const count = AppState.recurringTasks.filter(t => t.status === 'active').length;
    recurBadge.textContent = count > 0 ? count : '';
  }
}

// ============================================================
// View Switching
// ============================================================

function switchView(view) {
  AppState.currentView = view;

  // Update nav active states
  document.querySelectorAll('.nav-item').forEach(el => {
    el.classList.toggle('active', el.dataset.view === view);
  });

  // Hide all views, show current
  const views = ['homeView', 'tasksView', 'goalsView', 'calendarView', 'recurringView', 'activityView'];
  const viewMap = { home: 'homeView', tasks: 'tasksView', goals: 'goalsView', calendar: 'calendarView', recurring: 'recurringView', activity: 'activityView' };
  views.forEach(v => {
    document.getElementById(v).style.display = 'none';
  });
  document.getElementById(viewMap[view]).style.display = 'block';

  // Update title
  const titles = { home: 'Home', tasks: 'Tasks', goals: 'Goals', calendar: 'Calendar', recurring: 'Recurring Tasks', activity: 'Activity' };
  document.getElementById('viewTitle').textContent = titles[view] || view;

  renderCurrentView();

  // Close sidebar on mobile
  document.getElementById('sidebar').classList.remove('open');
}

function renderCurrentView() {
  switch(AppState.currentView) {
    case 'home': renderHomeView(); break;
    case 'tasks': renderTasksView(); break;
    case 'goals': renderGoalsView(); break;
    case 'calendar': renderCalendarView(); break;
    case 'recurring': renderRecurringView(); break;
    case 'activity': renderActivityView(); break;
  }
}

// ============================================================
// Sidebar Widgets
// ============================================================

function renderSidebarWidgets() {
  // Update sidebar stats
  const taskCount = AppState.tasks.filter(t => t.status !== 'completed').length;
  const eventCount = AppState.todayEvents.length;
  const goalCount = (AppState.goals || []).filter(g => g.status === 'active').length;
  const taskEl = document.getElementById('sidebarTaskCount');
  const eventEl = document.getElementById('sidebarEventCount');
  const goalEl = document.getElementById('sidebarGoalCount');
  if (taskEl) taskEl.textContent = taskCount;
  if (eventEl) eventEl.textContent = eventCount;
  if (goalEl) goalEl.textContent = goalCount;

  // Calendar sync time
  const syncEl = document.getElementById('calendarSync');
  if (syncEl && AppState.calendarLastSync) {
    const diff = Math.floor((new Date() - new Date(AppState.calendarLastSync)) / 60000);
    syncEl.textContent = diff < 1 ? 'Just now' : diff + 'm ago';
  }
}

// ============================================================
// Notification Center
// ============================================================

function renderNotificationBadge() {
  const badge = document.getElementById('notificationBadge');
  const count = AppState.notifications.length;
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'flex';
    badge.classList.add('pulse');
  } else {
    badge.style.display = 'none';
    badge.classList.remove('pulse');
  }
}

function toggleNotifications() {
  const panel = document.getElementById('notificationPanel');
  const isOpen = panel.classList.contains('open');
  if (isOpen) {
    panel.classList.remove('open');
  } else {
    renderNotificationList();
    panel.classList.add('open');
    // Clear the badge once the user has seen notifications
    const badge = document.getElementById('notificationBadge');
    if (badge) {
      badge.style.display = 'none';
      badge.classList.remove('pulse');
    }
  }
}

function renderNotificationList() {
  const container = document.getElementById('notificationList');
  if (AppState.notifications.length === 0) {
    container.innerHTML = '<div class="notification-empty">All clear! No notifications.</div>';
    return;
  }

  container.innerHTML = AppState.notifications.map((n, i) => `
    <div class="notification-item" onclick="handleNotificationClick(${i})">
      <div class="notification-icon" style="color:${n.color}">${getIcon(n.icon, 18)}</div>
      <div class="notification-content">
        <div class="notification-title">${escapeHtml(n.title)}</div>
        <div class="notification-detail">${n.detail}</div>
      </div>
    </div>
  `).join('');
}

function handleNotificationClick(index) {
  const n = AppState.notifications[index];
  if (!n) return;
  // Close the panel
  document.getElementById('notificationPanel').classList.remove('open');
  // Navigate based on type
  if (n.action === 'task' && n.taskId) {
    switchView('tasks');
    setTimeout(() => openTaskSideSheet(n.taskId), 100);
  } else if (n.action === 'recurring') {
    switchView('recurring');
  } else if (n.action === 'calendar') {
    switchView('calendar');
  }
}

// Close notification panel when clicking outside
document.addEventListener('click', (e) => {
  const wrapper = document.querySelector('.notification-wrapper');
  const panel = document.getElementById('notificationPanel');
  if (wrapper && !wrapper.contains(e.target) && panel.classList.contains('open')) {
    panel.classList.remove('open');
  }
});
// ============================================================
// DASHBOARD JS - PART 3
// View Rendering Functions
// Assumes: AppState, parseDate, getISTDate, formatTime,
// formatDate, formatRelativeTime, getGreeting, getWeekStart,
// isSameDay, getCalendarColor, animateCounter, getIcon,
// loadTasks/loadCalendarEvents/loadRecurringTasks/loadActivityFeed,
// computeNotifications, refreshAllData, switchView,
// renderCurrentView, renderSidebarWidgets, renderNotificationBadge
// ============================================================


// ------------------------------------------------------------
// 1. HOME VIEW
// Dashboard overview with stats, agenda, active work,
// up-next queue, and upcoming deadlines.
// ------------------------------------------------------------

function renderHomeView() {
  // -- Greeting --
  const greetingEl = document.getElementById('greetingText');
  const dateEl = document.getElementById('greetingDate');
  if (greetingEl) {
    greetingEl.textContent = getGreeting() + ', Naveen';
  }
  if (dateEl) {
    const now = new Date();
    dateEl.textContent = now.toLocaleDateString('en-IN', {
      weekday: 'long',
      month: 'long',
      day: 'numeric',
      year: 'numeric',
      timeZone: 'Asia/Kolkata'
    });
  }

  // -- Stat counters --
  const activeTasks = AppState.tasks.filter(t => t.status === 'backlog' || t.status === 'progress').length;
  const todayEventsCount = AppState.todayEvents.length;
  const recurringCount = AppState.recurringTasks.length;
  const allGoals = AppState.goals || [];
  const activeGoals = allGoals.filter(g => g.status === 'active');

  animateCounter('statActiveGoals', activeGoals.length);
  animateCounter('statActiveTasks', activeTasks);
  animateCounter('statTodayEvents', todayEventsCount);
  animateCounter('statRecurring', recurringCount);

  // -- Active Goals --
  renderHomeGoals(activeGoals);

  // -- Today's Agenda --
  renderTodayAgenda();

  // -- Active Work --
  renderActiveWork();

  // -- Up Next --
  renderUpNext();

  // -- Upcoming Deadlines --
  renderUpcomingDeadlines();
}

function renderHomeGoals(activeGoals) {
  const section = document.getElementById('homeGoalsSection');
  const container = document.getElementById('homeGoals');
  if (!section || !container) return;

  if (activeGoals.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  container.innerHTML = activeGoals.slice(0, 4).map(goal => {
    const taskCount = (goal.tasks || []).length;
    return `
      <div class="goal-card priority-${goal.priority}" onclick="openGoalSideSheet('${goal.id}')" style="margin-bottom: var(--space-3);">
        <div class="goal-card-header">
          <div class="goal-card-title">${escapeHtml(goal.title)}</div>
          <span class="goal-priority-badge ${goal.priority}">${goal.priority}</span>
        </div>
        <div class="goal-progress-bar">
          <div class="goal-progress-fill" style="width: ${goal.progress}%"></div>
        </div>
        <div class="goal-card-footer">
          <span class="goal-progress-text">${goal.progress}%</span>
          ${taskCount > 0 ? `<span class="goal-tasks-badge">${getIcon('list', 12)} ${taskCount} task${taskCount !== 1 ? 's' : ''}</span>` : ''}
        </div>
      </div>`;
  }).join('');
}

function renderTodayAgenda() {
  const container = document.getElementById('todayAgenda');
  if (!container) return;

  const todayStr = getISTDate();
  const todayStart = new Date(todayStr + 'T00:00:00+05:30');
  const todayEnd = new Date(todayStr + 'T23:59:59+05:30');

  // Merge calendar events and tasks with deadlines today
  const agendaItems = [];

  const now = new Date();

  // Add today's calendar events:
  // - Skip all-day events and multi-day/spanning events (duration >= 20 hours)
  // - Skip events that have already ended
  AppState.todayEvents.forEach(e => {
    if (e.allDay) return;
    // Detect effectively-all-day events (span >= 20 hours)
    if (e._end && e._start && (e._end - e._start) >= 20 * 3600000) return;
    // Skip past events
    if (e._end && e._end < now) return;

    agendaItems.push({
      type: 'event',
      time: e._start,
      title: e.summary,
      color: e._color,
      calendar: e.calendar,
      location: e.location
    });
  });

  // Add tasks with deadlines today (not yet past)
  AppState.tasks.filter(t => {
    if (!t.deadline || t.status === 'completed') return false;
    const dl = new Date(t.deadline);
    return dl >= now && dl <= todayEnd;
  }).forEach(t => {
    agendaItems.push({
      type: 'task',
      time: new Date(t.deadline),
      title: t.title,
      priority: t.priority,
      taskId: t.id
    });
  });

  // Sort by time
  agendaItems.sort((a, b) => (a.time || 0) - (b.time || 0));

  if (agendaItems.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">${getIcon('calendar', 32)}</div>
        <p>No upcoming events or tasks for today</p>
      </div>`;
    return;
  }

  container.innerHTML = agendaItems.map(item => {
    const timeStr = item.time ? formatTime(item.time) : '';
    const icon = item.type === 'event' ? getIcon('calendar', 16) : getIcon('tasks', 16);
    const colorDot = item.type === 'event'
      ? `<span class="agenda-color-dot" style="background:${item.color}"></span>`
      : '';

    return `
      <div class="agenda-item" ${item.taskId ? `onclick="openTaskSideSheet(${item.taskId})"` : ''}>
        <div class="agenda-time">${timeStr}</div>
        <div class="agenda-icon">${icon}</div>
        <div class="agenda-content">
          <div class="agenda-title">${colorDot}${item.title}</div>
          ${item.location ? `<div class="agenda-meta">${item.location}</div>` : ''}
        </div>
      </div>`;
  }).join('');
}

function renderActiveWork() {
  const container = document.getElementById('activeWork');
  if (!container) return;

  const inProgress = AppState.tasks.filter(t => t.status === 'progress');

  if (inProgress.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">${getIcon('flag', 32)}</div>
        <p>No tasks in progress</p>
      </div>`;
    return;
  }

  container.innerHTML = inProgress.map(t => {
    const priorityColors = { high: '#ef4444', medium: '#f59e0b', low: '#10b981' };
    const desc = t.description
      ? t.description.substring(0, 100) + (t.description.length > 100 ? '...' : '')
      : '';

    return `
      <div class="active-work-card" onclick="openTaskSideSheet(${t.id})">
        <div class="active-work-header">
          <span class="priority-dot" style="background:${priorityColors[t.priority] || '#6366f1'}"></span>
          <span class="active-work-title">${t.title}</span>
        </div>
        ${desc ? `<div class="active-work-desc">${desc}</div>` : ''}
      </div>`;
  }).join('');
}

function renderUpNext() {
  const container = document.getElementById('upNext');
  if (!container) return;

  const priorityOrder = { high: 0, medium: 1, low: 2 };
  const backlogTasks = AppState.tasks
    .filter(t => t.status === 'backlog')
    .sort((a, b) => (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2))
    .slice(0, 3);

  if (backlogTasks.length === 0) {
    container.innerHTML = `
      <div class="empty-state-small">No backlog tasks</div>`;
    return;
  }

  const priorityColors = { high: '#ef4444', medium: '#f59e0b', low: '#10b981' };

  container.innerHTML = backlogTasks.map(t => `
    <div class="up-next-card" onclick="openTaskSideSheet(${t.id})">
      <span class="priority-dot" style="background:${priorityColors[t.priority] || '#6366f1'}"></span>
      <div class="up-next-info">
        <div class="up-next-title">${t.title}</div>
        <div class="up-next-priority">${t.priority}</div>
      </div>
    </div>`
  ).join('');
}

function renderUpcomingDeadlines() {
  const container = document.getElementById('upcomingDeadlines');
  if (!container) return;

  const now = new Date();
  const sevenDaysOut = new Date(now);
  sevenDaysOut.setDate(sevenDaysOut.getDate() + 7);

  const upcoming = AppState.tasks
    .filter(t => {
      if (!t.deadline || t.status === 'completed') return false;
      const dl = new Date(t.deadline);
      return dl >= now && dl <= sevenDaysOut;
    })
    .sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

  if (upcoming.length === 0) {
    container.innerHTML = `
      <div class="empty-state-small">No upcoming deadlines</div>`;
    return;
  }

  container.innerHTML = upcoming.map(t => {
    const dl = new Date(t.deadline);
    const relative = formatRelativeTime(new Date(dl.getTime() - (now.getTime() - dl.getTime())));
    const diffMs = dl - now;
    const diffDays = Math.ceil(diffMs / 86400000);
    let urgency = '';
    if (diffDays <= 1) urgency = 'urgent';
    else if (diffDays <= 3) urgency = 'soon';

    const deadlineLabel = diffDays === 0 ? 'Today'
      : diffDays === 1 ? 'Tomorrow'
      : `In ${diffDays} days`;

    return `
      <div class="deadline-card ${urgency}">
        <div class="deadline-title">${t.title}</div>
        <div class="deadline-time">${getIcon('clock', 12)} ${deadlineLabel} &middot; ${formatDate(dl)}</div>
      </div>`;
  }).join('');
}


// ------------------------------------------------------------
// 2. TASKS VIEW
// Kanban board with filtering, sorting, drag-and-drop support,
// and inline actions.
// ------------------------------------------------------------

function renderTasksView() {
  const sortBy = document.getElementById('taskSortBy')?.value || 'newest';
  const searchQuery = (document.getElementById('taskSearchInput')?.value || '').toLowerCase().trim();

  // Filter
  let filtered = AppState.tasks;
  if (searchQuery) {
    filtered = filtered.filter(t => {
      const haystack = (t.title + ' ' + (t.description || '')).toLowerCase();
      return haystack.includes(searchQuery);
    });
  }

  // Sort
  const priorityOrder = { high: 0, medium: 1, low: 2 };
  switch (sortBy) {
    case 'newest':
      filtered = [...filtered].sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
      break;
    case 'priority':
      filtered = [...filtered].sort((a, b) => (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2));
      break;
    case 'deadline':
      filtered = [...filtered].sort((a, b) => {
        const dlA = a.deadline ? new Date(a.deadline).getTime() : Infinity;
        const dlB = b.deadline ? new Date(b.deadline).getTime() : Infinity;
        return dlA - dlB;
      });
      break;
  }

  // Group by status
  const groups = { backlog: [], progress: [], completed: [] };
  filtered.forEach(t => { if (groups[t.status]) groups[t.status].push(t); });

  const priorityColors = { high: '#ef4444', medium: '#f59e0b', low: '#10b981' };

  Object.keys(groups).forEach(status => {
    const column = document.getElementById(status);
    if (!column) return;

    if (groups[status].length === 0) {
      column.innerHTML = '<div class="kanban-empty">No tasks</div>';
    } else {
      column.innerHTML = groups[status].map(t => {
        const deadlineStr = t.deadline ? formatRelativeTime(new Date(t.deadline)) : '';
        const isOverdue = t.deadline && t.status !== 'completed' && new Date(t.deadline) < new Date();

        const subtaskBadge = (t.subtasks && t.subtasks.length > 0) ? `<span class="task-subtask-badge">${getIcon('check-square', 11)} ${t.subtasks.filter(s=>s.completed).length}/${t.subtasks.length}</span>` : '';
        const taskFiles = getTaskFiles(t);
        const fileBadge = taskFiles.length > 0 ? `<span class="task-file-badge">${getIcon('paperclip', 11)} ${taskFiles.length}</span>` : '';
        const badgesRow = (subtaskBadge || fileBadge) ? `<div class="task-badges-row">${subtaskBadge}${fileBadge}</div>` : '';

        return `
          <div class="task-card" draggable="true" data-task-id="${t.id}"
               ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)"
               onclick="handleTaskCardClick(event, ${t.id})">
            <div class="task-card-header">
              <span style="background:${priorityColors[t.priority] || '#6366f1'}; width:7px; height:7px; border-radius:50%; display:inline-block; flex-shrink:0; margin-top:5px;"></span>
              <span class="task-card-title">${t.title}</span>
            </div>
            ${deadlineStr ? `<div class="task-card-meta"><span class="task-deadline ${isOverdue ? 'overdue' : ''}">${getIcon('clock', 11)} ${deadlineStr}</span></div>` : ''}
            ${badgesRow}
            <div class="task-card-actions">
              <button onclick="event.stopPropagation(); openEditTaskModal(${t.id})" title="Edit">${getIcon('edit', 13)}</button>
              <button onclick="event.stopPropagation(); deleteTask(${t.id})" title="Delete">${getIcon('trash', 13)}</button>
            </div>
          </div>`;
      }).join('');
    }

    const countEl = document.getElementById(status + '-count');
    if (countEl) countEl.textContent = groups[status].length;
  });

  const activeCount = AppState.tasks.filter(t => t.status === 'backlog' || t.status === 'progress').length;
  const navBadge = document.getElementById('nav-tasks-count');
  if (navBadge) navBadge.textContent = activeCount > 0 ? activeCount : '';
}

function handleTaskCardClick(event, taskId) {
  // Prevent opening side sheet when clicking action buttons
  if (event.target.closest('.task-card-actions')) return;
  openTaskSideSheet(taskId);
}

// -- Drag and Drop --

function handleDragStart(event) {
  const card = event.target.closest('.task-card');
  if (!card) return;
  event.dataTransfer.setData('text/plain', card.dataset.taskId);
  card.classList.add('dragging');
  // Highlight drop zones
  document.querySelectorAll('.kanban-cards').forEach(col => {
    col.classList.add('drag-target');
  });
}

function handleDragEnd(event) {
  const card = event.target.closest('.task-card');
  if (card) card.classList.remove('dragging');
  document.querySelectorAll('.kanban-cards').forEach(col => {
    col.classList.remove('drag-target', 'drag-over');
  });
}

// Set up column drop zones (called once on init)
function initDragDrop() {
  document.querySelectorAll('.kanban-cards').forEach(col => {
    col.addEventListener('dragover', e => {
      e.preventDefault();
      col.classList.add('drag-over');
    });
    col.addEventListener('dragleave', () => {
      col.classList.remove('drag-over');
    });
    col.addEventListener('drop', e => {
      e.preventDefault();
      col.classList.remove('drag-over');
      const taskId = parseInt(e.dataTransfer.getData('text/plain'));
      const newStatus = col.dataset.status;
      if (taskId && newStatus) {
        updateTaskStatus(taskId, newStatus);
      }
    });
  });
}


// ------------------------------------------------------------
// 3. CALENDAR VIEW
// Week and day views with time grid, event positioning,
// all-day events row, and current-time indicator.
// ------------------------------------------------------------

function renderCalendarView() {
  // Initialize week start if needed
  if (!AppState.calendarWeekStart) {
    AppState.calendarWeekStart = getWeekStart(new Date());
  }

  const grid = document.getElementById('calendarGrid');
  if (!grid) return;

  if (AppState.calendarMode === 'week') {
    renderCalendarWeek(grid);
  } else {
    renderCalendarDay(grid);
  }

  // Update range label
  updateCalendarRange();
}

function updateCalendarRange() {
  const rangeEl = document.getElementById('calendarRange');
  if (!rangeEl) return;

  const start = new Date(AppState.calendarWeekStart);

  if (AppState.calendarMode === 'week') {
    const end = new Date(start);
    end.setDate(end.getDate() + 6);
    const startStr = start.toLocaleDateString('en-IN', { month: 'short', day: 'numeric', timeZone: 'Asia/Kolkata' });
    const endStr = end.toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'Asia/Kolkata' });
    rangeEl.textContent = startStr + ' - ' + endStr;
  } else {
    rangeEl.textContent = start.toLocaleDateString('en-IN', {
      weekday: 'long',
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      timeZone: 'Asia/Kolkata'
    });
  }
}

// -- Calendar Collision Detection --
function computeEventColumns(events) {
  if (!events.length) return [];
  const sorted = events.map((e, i) => ({ ...e, _idx: i })).sort((a, b) => a._start - b._start || (b._end || b._start) - (a._end || a._start));
  const groups = [];
  let currentGroup = [sorted[0]];
  let groupEnd = sorted[0]._end || sorted[0]._start;

  for (let i = 1; i < sorted.length; i++) {
    const ev = sorted[i];
    if (ev._start < groupEnd) {
      currentGroup.push(ev);
      const evEnd = ev._end || ev._start;
      if (evEnd > groupEnd) groupEnd = evEnd;
    } else {
      groups.push(currentGroup);
      currentGroup = [ev];
      groupEnd = ev._end || ev._start;
    }
  }
  groups.push(currentGroup);

  const result = new Array(events.length);
  for (const group of groups) {
    const columns = [];
    for (const ev of group) {
      let placed = false;
      for (let c = 0; c < columns.length; c++) {
        const lastInCol = columns[c][columns[c].length - 1];
        if ((lastInCol._end || lastInCol._start) <= ev._start) {
          columns[c].push(ev);
          result[ev._idx] = { col: c, totalCols: 0 };
          placed = true;
          break;
        }
      }
      if (!placed) {
        columns.push([ev]);
        result[ev._idx] = { col: columns.length - 1, totalCols: 0 };
      }
    }
    for (const ev of group) {
      result[ev._idx].totalCols = columns.length;
    }
  }
  return result;
}

// -- Calendar Event Popover --
function showEventPopover(eventData, clickEvent) {
  // Remove existing popover
  const existing = document.querySelector('.cal-event-popover');
  if (existing) existing.remove();

  const popover = document.createElement('div');
  popover.className = 'cal-event-popover';

  const timeStr = eventData.allDay ? 'All day' : (formatTime(eventData._start) + '  ' + formatTime(eventData._end || eventData._start));

  let html = `
    <div class="cal-popover-header">
      <div class="cal-popover-title">${eventData.summary}</div>
      <button class="cal-popover-close" onclick="this.closest('.cal-event-popover').remove()">${getIcon('x', 16)}</button>
    </div>
    <div class="cal-popover-row">${getIcon('clock', 14)} <span>${timeStr}</span></div>`;

  if (eventData.location) {
    html += `<div class="cal-popover-row">${getIcon('map-pin', 14)} <span>${eventData.location}</span></div>`;
  }
  if (eventData.calendar) {
    html += `<div class="cal-popover-calendar-badge" style="background:${eventData._color}20;color:${eventData._color};">${eventData.calendar}</div>`;
  }
  if (eventData.description) {
    html += `<div class="cal-popover-description">${eventData.description}</div>`;
  }

  popover.innerHTML = html;
  document.body.appendChild(popover);

  // Position near click
  const rect = popover.getBoundingClientRect();
  let x = clickEvent.clientX + 8;
  let y = clickEvent.clientY + 8;
  if (x + rect.width > window.innerWidth - 16) x = clickEvent.clientX - rect.width - 8;
  if (y + rect.height > window.innerHeight - 16) y = clickEvent.clientY - rect.height - 8;
  if (x < 8) x = 8;
  if (y < 8) y = 8;
  popover.style.left = x + 'px';
  popover.style.top = y + 'px';

  // Click outside to dismiss
  setTimeout(() => {
    function dismiss(e) {
      if (!popover.contains(e.target)) {
        popover.remove();
        document.removeEventListener('mousedown', dismiss);
      }
    }
    document.addEventListener('mousedown', dismiss);
  }, 0);
}

function renderCalendarWeek(grid) {
  const weekStart = new Date(AppState.calendarWeekStart);
  const now = new Date();
  const today = new Date();

  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + i);
    days.push(d);
  }

  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekEnd.getDate() + 7);
  const weekEvents = AppState.allCalendarEvents.filter(e =>
    e._start < weekEnd && (e._end || e._start) >= weekStart
  );

  const isSpanning = e => !e.allDay && e._end && e._start && (e._end - e._start) >= 20 * 3600000;
  const allDayEvents = weekEvents.filter(e => e.allDay);
  const timedEvents = weekEvents.filter(e => !e.allDay && !isSpanning(e));

  const startHour = 6;
  const endHour = 22;
  const totalHours = endHour - startHour;

  const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  let headersHtml = '<div class="cal-header-cell cal-time-gutter"></div>';
  days.forEach((d, i) => {
    const isToday = isSameDay(d, today);
    headersHtml += `
      <div class="cal-header-cell ${isToday ? 'cal-today-header' : ''}">
        <span class="cal-day-name">${dayNames[i]}</span>
        <span class="cal-day-num ${isToday ? 'cal-today-num' : ''}">${d.getDate()}</span>
      </div>`;
  });

  // Store events globally for popover access
  window._calEventLookup = window._calEventLookup || {};

  let allDayHtml = '<div class="cal-allday-gutter">All day</div>';
  days.forEach(d => {
    const dayAllDay = allDayEvents.filter(e => {
      const eStart = new Date(e._start); eStart.setHours(0,0,0,0);
      const eEnd = e._end ? new Date(e._end) : new Date(eStart); eEnd.setHours(23,59,59,999);
      const ds = new Date(d); ds.setHours(0,0,0,0);
      const de = new Date(d); de.setHours(23,59,59,999);
      return eStart <= de && eEnd >= ds;
    });
    const eventsHtml = dayAllDay.map(e => {
      const eid = 'cev_' + Math.random().toString(36).slice(2, 10);
      window._calEventLookup[eid] = e;
      return `<div class="cal-allday-event" style="background:${e._color}20; color:${e._color}; border-left:3px solid ${e._color};" onclick="showEventPopover(window._calEventLookup['${eid}'], event)">${e.summary}</div>`;
    }).join('');
    allDayHtml += `<div class="cal-allday-cell">${eventsHtml}</div>`;
  });

  let timeGridHtml = '';
  for (let h = startHour; h < endHour; h++) {
    const label = h === 0 ? '12 AM' : h < 12 ? h + ' AM' : h === 12 ? '12 PM' : (h - 12) + ' PM';
    timeGridHtml += `
      <div class="cal-time-row">
        <div class="cal-time-label">${label}</div>
        ${days.map(() => '<div class="cal-time-cell"></div>').join('')}
      </div>`;
  }

  let eventBlocksHtml = '';
  const hourHeight = 64;

  days.forEach((d, colIndex) => {
    const dayStart = new Date(d); dayStart.setHours(startHour, 0, 0, 0);
    const dayEnd = new Date(d); dayEnd.setHours(endHour, 0, 0, 0);
    const dayEvents = timedEvents.filter(e => isSameDay(e._start, d) || isSameDay(e._end || e._start, d));

    const cols = computeEventColumns(dayEvents);
    const colWidthPercent = (100 / 7);
    const leftPercent = colWidthPercent * colIndex;

    dayEvents.forEach((e, i) => {
      const eventStart = e._start < dayStart ? dayStart : e._start;
      const eventEnd = (e._end || e._start) > dayEnd ? dayEnd : (e._end || e._start);
      const startMinutes = (eventStart.getHours() - startHour) * 60 + eventStart.getMinutes();
      const endMinutes = (eventEnd.getHours() - startHour) * 60 + eventEnd.getMinutes();
      const topPx = (startMinutes / 60) * hourHeight;
      const heightPx = Math.max(((endMinutes - startMinutes) / 60) * hourHeight, 20);

      const { col, totalCols } = cols[i] || { col: 0, totalCols: 1 };
      const slotWidth = colWidthPercent / totalCols;
      const slotLeft = leftPercent + slotWidth * col;

      const eid = 'cev_' + Math.random().toString(36).slice(2, 10);
      window._calEventLookup[eid] = e;

      eventBlocksHtml += `
        <div class="cal-event-block" style="
          top: ${topPx}px;
          height: ${heightPx}px;
          left: calc(60px + ${slotLeft}% + 2px);
          width: calc(${slotWidth}% - 4px);
          background: ${e._color}20;
          border-left: 3px solid ${e._color};
          color: ${e._color};
        " onclick="showEventPopover(window._calEventLookup['${eid}'], event)">
          <div class="cal-event-time">${formatTime(e._start)}</div>
          <div class="cal-event-title">${e.summary}</div>
        </div>`;
    });

    if (isSameDay(d, now)) {
      const nowMinutes = (now.getHours() - startHour) * 60 + now.getMinutes();
      if (nowMinutes >= 0 && nowMinutes <= totalHours * 60) {
        const nowPx = (nowMinutes / 60) * hourHeight;
        eventBlocksHtml += `
          <div class="cal-now-line" style="top:${nowPx}px; left:calc(60px + ${leftPercent}%); width:calc(${colWidthPercent}%);">
            <div class="cal-now-dot"></div>
          </div>`;
      }
    }
  });

  grid.innerHTML = `
    <div class="cal-week-view">
      <div class="cal-headers">${headersHtml}</div>
      <div class="cal-allday-row">${allDayHtml}</div>
      <div class="cal-body">
        <div class="cal-time-grid">${timeGridHtml}</div>
        <div class="cal-events-layer">${eventBlocksHtml}</div>
      </div>
    </div>`;
}

function renderCalendarDay(grid) {
  const dayDate = new Date(AppState.calendarWeekStart);
  const now = new Date();
  const isToday = isSameDay(dayDate, now);

  const dayStart = new Date(dayDate); dayStart.setHours(0, 0, 0, 0);
  const dayEnd = new Date(dayDate); dayEnd.setHours(23, 59, 59, 999);

  const dayEvents = AppState.allCalendarEvents.filter(e =>
    e._start <= dayEnd && (e._end || e._start) >= dayStart
  );

  const isDaySpanning = e => !e.allDay && e._end && e._start && (e._end - e._start) >= 20 * 3600000;
  const allDayEvents = dayEvents.filter(e => e.allDay);
  const timedEvents = dayEvents.filter(e => !e.allDay && !isDaySpanning(e));

  const startHour = 6;
  const endHour = 22;
  const totalHours = endHour - startHour;
  const hourHeight = 64;

  const dayName = dayDate.toLocaleDateString('en-IN', { weekday: 'long', timeZone: 'Asia/Kolkata' });
  const dateNum = dayDate.getDate();

  window._calEventLookup = window._calEventLookup || {};

  let allDayHtml = '';
  if (allDayEvents.length > 0) {
    allDayHtml = `
      <div class="cal-allday-row cal-day-allday">
        <div class="cal-allday-gutter">All day</div>
        <div class="cal-allday-cell">
          ${allDayEvents.map(e => {
            const eid = 'cev_' + Math.random().toString(36).slice(2, 10);
            window._calEventLookup[eid] = e;
            return `<div class="cal-allday-event" style="background:${e._color}20; color:${e._color}; border-left:3px solid ${e._color};" onclick="showEventPopover(window._calEventLookup['${eid}'], event)">${e.summary}</div>`;
          }).join('')}
        </div>
      </div>`;
  }

  let timeGridHtml = '';
  for (let h = startHour; h < endHour; h++) {
    const label = h === 0 ? '12 AM' : h < 12 ? h + ' AM' : h === 12 ? '12 PM' : (h - 12) + ' PM';
    timeGridHtml += `
      <div class="cal-time-row">
        <div class="cal-time-label">${label}</div>
        <div class="cal-time-cell"></div>
      </div>`;
  }

  let eventBlocksHtml = '';
  const gridStartDate = new Date(dayDate); gridStartDate.setHours(startHour, 0, 0, 0);
  const gridEndDate = new Date(dayDate); gridEndDate.setHours(endHour, 0, 0, 0);

  const cols = computeEventColumns(timedEvents);

  timedEvents.forEach((e, i) => {
    const eventStart = e._start < gridStartDate ? gridStartDate : e._start;
    const eventEnd = (e._end || e._start) > gridEndDate ? gridEndDate : (e._end || e._start);
    const startMinutes = (eventStart.getHours() - startHour) * 60 + eventStart.getMinutes();
    const endMinutes = (eventEnd.getHours() - startHour) * 60 + eventEnd.getMinutes();
    const topPx = (startMinutes / 60) * hourHeight;
    const heightPx = Math.max(((endMinutes - startMinutes) / 60) * hourHeight, 20);

    const { col, totalCols } = cols[i] || { col: 0, totalCols: 1 };
    const slotWidth = (100 - 62) / totalCols; // in px approximate  use calc
    const eid = 'cev_' + Math.random().toString(36).slice(2, 10);
    window._calEventLookup[eid] = e;

    eventBlocksHtml += `
      <div class="cal-event-block cal-day-event" style="
        top: ${topPx}px;
        height: ${heightPx}px;
        left: calc(62px + ${col} * ((100% - 70px) / ${totalCols}));
        width: calc((100% - 70px) / ${totalCols} - 2px);
        background: ${e._color}20;
        border-left: 3px solid ${e._color};
        color: ${e._color};
      " onclick="showEventPopover(window._calEventLookup['${eid}'], event)">
        <div class="cal-event-time">${formatTime(e._start)}  ${formatTime(e._end || e._start)}</div>
        <div class="cal-event-title">${e.summary}</div>
        ${e.location ? `<div class="cal-event-location">${e.location}</div>` : ''}
      </div>`;
  });

  if (isToday) {
    const nowMinutes = (now.getHours() - startHour) * 60 + now.getMinutes();
    if (nowMinutes >= 0 && nowMinutes <= totalHours * 60) {
      const nowPx = (nowMinutes / 60) * hourHeight;
      eventBlocksHtml += `
        <div class="cal-now-line" style="top: ${nowPx}px; left: 60px; right: 0;">
          <div class="cal-now-dot"></div>
        </div>`;
    }
  }

  grid.innerHTML = `
    <div class="cal-day-view">
      <div class="cal-headers">
        <div class="cal-header-cell cal-time-gutter"></div>
        <div class="cal-header-cell ${isToday ? 'cal-today-header' : ''}">
          <span class="cal-day-name">${dayName}</span>
          <span class="cal-day-num ${isToday ? 'cal-today-num' : ''}">${dateNum}</span>
        </div>
      </div>
      ${allDayHtml}
      <div class="cal-body">
        <div class="cal-time-grid">${timeGridHtml}</div>
        <div class="cal-events-layer">${eventBlocksHtml}</div>
      </div>
    </div>`;
}


// -- Calendar Navigation --

function calendarPrev() {
  const d = new Date(AppState.calendarWeekStart);
  d.setDate(d.getDate() - (AppState.calendarMode === 'week' ? 7 : 1));
  AppState.calendarWeekStart = d;
  renderCalendarView();
}

function calendarNext() {
  const d = new Date(AppState.calendarWeekStart);
  d.setDate(d.getDate() + (AppState.calendarMode === 'week' ? 7 : 1));
  AppState.calendarWeekStart = d;
  renderCalendarView();
}

function calendarToday() {
  AppState.calendarWeekStart = getWeekStart(new Date());
  renderCalendarView();
}

function setCalendarMode(mode) {
  AppState.calendarMode = mode;
  document.getElementById('weekViewBtn').classList.toggle('active', mode === 'week');
  document.getElementById('dayViewBtn').classList.toggle('active', mode === 'day');
  renderCalendarView();
}


// ------------------------------------------------------------
// 4. RECURRING TASKS VIEW
// Cards displaying recurring task definitions with schedule
// indicators, run counts, and status badges.
// ------------------------------------------------------------

function renderRecurringView() {
  const container = document.getElementById('recurringGrid');
  if (!container) return;

  if (AppState.recurringTasks.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">${getIcon('recurring', 40)}</div>
        <p>No recurring tasks configured</p>
      </div>`;
    return;
  }

  container.innerHTML = AppState.recurringTasks.map(t => {
    const scheduleText = formatSchedule(t.schedule_type, t.schedule_value);
    const nextRun = t.next_run ? formatRelativeTime(new Date(t.next_run)) : 'Not scheduled';
    const lastRun = t.last_run ? formatRelativeTime(new Date(t.last_run)) : 'Never';
    const isActive = t.status === 'active';
    const statusClass = isActive ? 'badge-active' : 'badge-paused';
    const statusLabel = isActive ? 'Active' : 'Paused';

    // Extract a short title from the prompt (first line, truncated)
    const titleLine = t.prompt.split('\n')[0].replace(/^[\d.)\-:\s]+/, '').trim();
    const title = titleLine.length > 80 ? titleLine.slice(0, 77) + '...' : titleLine;

    // Build schedule indicator (7 dots for Mon-Sun)
    const activeDays = getActiveDaysFromSchedule(t.schedule_type, t.schedule_value);
    const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
    const dotsHtml = dayLabels.map((label, i) => {
      const isActiveDay = activeDays.includes(i);
      return `<span class="schedule-dot ${isActiveDay ? 'schedule-dot-active' : ''}" title="${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i]}">${label}</span>`;
    }).join('');

    // Goal link
    const goalTag = t.goal_id ? `<span class="recurring-goal-tag">${getIcon('target', 12)} Linked to goal</span>` : '';

    return `
      <div class="recurring-card">
        <div class="recurring-card-header">
          <div class="recurring-card-title">${escapeHtml(title)}</div>
          <span class="badge ${statusClass}">${statusLabel}</span>
        </div>
        <div class="recurring-schedule">
          <div class="recurring-schedule-text">${getIcon('clock', 14)} ${scheduleText}</div>
          <div class="schedule-dots">${dotsHtml}</div>
        </div>
        <div class="recurring-card-footer">
          <span class="recurring-meta">${getIcon('recurring', 14)} Next: ${nextRun}</span>
          <span class="recurring-meta">Last: ${lastRun}</span>
          ${goalTag}
        </div>
      </div>`;
  }).join('');
}

/**
 * Parse a schedule (cron or interval) into human-readable text.
 */
function formatSchedule(type, value) {
  if (type === 'interval') {
    const mins = parseInt(value);
    if (mins < 60) return `Every ${mins} minute${mins !== 1 ? 's' : ''}`;
    const hours = Math.floor(mins / 60);
    const remMins = mins % 60;
    if (remMins === 0) return `Every ${hours} hour${hours !== 1 ? 's' : ''}`;
    return `Every ${hours}h ${remMins}m`;
  }

  if (type === 'once') {
    return 'One-time: ' + formatDate(new Date(value));
  }

  if (type !== 'cron') return value;

  // Parse cron expression: minute hour dayOfMonth month dayOfWeek
  const parts = value.split(/\s+/);
  if (parts.length < 5) return value;

  const [minute, hour, dom, month, dow] = parts;

  // Format time
  let timeStr = '';
  if (hour !== '*' && minute !== '*') {
    const h = parseInt(hour);
    const m = parseInt(minute);
    const period = h >= 12 ? 'PM' : 'AM';
    const displayH = h === 0 ? 12 : h > 12 ? h - 12 : h;
    timeStr = displayH + ':' + String(m).padStart(2, '0') + ' ' + period;
  }

  // Day of week
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  if (dom === '*' && month === '*' && dow === '*') {
    return timeStr ? `Daily at ${timeStr}` : 'Every minute';
  }

  if (dow !== '*' && dom === '*') {
    const dowValues = parseCronField(dow, 0, 6);
    if (dowValues.length === 7) {
      return timeStr ? `Daily at ${timeStr}` : 'Daily';
    }
    if (dowValues.length === 5 && !dowValues.includes(0) && !dowValues.includes(6)) {
      return timeStr ? `Weekdays at ${timeStr}` : 'Weekdays';
    }
    if (dowValues.length === 2 && dowValues.includes(0) && dowValues.includes(6)) {
      return timeStr ? `Weekends at ${timeStr}` : 'Weekends';
    }
    const dayList = dowValues.map(d => dayNames[d]).join(', ');
    return timeStr ? `${dayList} at ${timeStr}` : dayList;
  }

  if (dom !== '*' && dow === '*') {
    const dayNum = dom.includes('/') ? dom : 'day ' + dom;
    return timeStr ? `Monthly on ${dayNum} at ${timeStr}` : `Monthly on ${dayNum}`;
  }

  return timeStr ? `${value} (at ${timeStr})` : value;
}

/**
 * Parse a cron field (e.g., "1,3,5" or "1-5" or "* /2") into an array of integer values.
 */
function parseCronField(field, min, max) {
  if (field === '*') {
    const result = [];
    for (let i = min; i <= max; i++) result.push(i);
    return result;
  }

  const values = new Set();

  field.split(',').forEach(part => {
    part = part.trim();

    // Handle step values: */2 or 1-5/2
    if (part.includes('/')) {
      const [range, step] = part.split('/');
      const stepNum = parseInt(step);
      let start = min;
      let end = max;
      if (range !== '*') {
        if (range.includes('-')) {
          [start, end] = range.split('-').map(Number);
        } else {
          start = parseInt(range);
        }
      }
      for (let i = start; i <= end; i += stepNum) {
        values.add(i);
      }
      return;
    }

    // Handle ranges: 1-5
    if (part.includes('-')) {
      const [start, end] = part.split('-').map(Number);
      for (let i = start; i <= end; i++) {
        values.add(i);
      }
      return;
    }

    // Single value
    values.add(parseInt(part));
  });

  return Array.from(values).sort((a, b) => a - b);
}

/**
 * Determine which days of the week a schedule is active on.
 * Returns array of indices 0-6 where 0=Monday, 6=Sunday.
 */
function getActiveDaysFromSchedule(type, value) {
  if (type !== 'cron') {
    // Intervals and one-time tasks run on all days
    return [0, 1, 2, 3, 4, 5, 6];
  }

  const parts = value.split(/\s+/);
  if (parts.length < 5) return [0, 1, 2, 3, 4, 5, 6];

  const dow = parts[4];
  const dom = parts[2];

  if (dow === '*') {
    // Runs every day (or specific days of month, but show all)
    return [0, 1, 2, 3, 4, 5, 6];
  }

  // Parse cron DOW: 0=Sunday in cron, convert to our 0=Monday
  const cronDays = parseCronField(dow, 0, 6);
  return cronDays.map(d => {
    // Convert from cron (0=Sun) to display (0=Mon)
    return d === 0 ? 6 : d - 1;
  }).sort((a, b) => a - b);
}


// ------------------------------------------------------------
// 5. ACTIVITY VIEW
// Chronological feed of all system activity, grouped by day,
// with type-based filtering and icons.
// ------------------------------------------------------------

function renderActivityView() {
  const container = document.getElementById('activityTimeline');
  if (!container) return;

  const filter = AppState.activityFilter || 'all';

  // Filter entries
  let entries = AppState.activityFeed;
  if (filter !== 'all') {
    entries = entries.filter(e => {
      if (filter === 'task') return e.type.startsWith('task_');
      if (filter === 'call') return e.type === 'call';
      if (filter === 'recurring') return e.type === 'recurring_run';
      return true;
    });
  }

  if (entries.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">${getIcon('activity', 40)}</div>
        <p>No activity to show</p>
      </div>`;
    return;
  }

  // Sort by timestamp descending
  const sorted = [...entries].sort((a, b) =>
    new Date(b.timestamp) - new Date(a.timestamp)
  );

  // Group by day
  const groups = [];
  let currentGroup = null;

  sorted.forEach(entry => {
    const entryDate = new Date(entry.timestamp);
    const dateKey = entryDate.toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });

    if (!currentGroup || currentGroup.dateKey !== dateKey) {
      currentGroup = { dateKey, date: entryDate, entries: [] };
      groups.push(currentGroup);
    }
    currentGroup.entries.push(entry);
  });

  // Build HTML
  const today = getISTDate();
  const yesterday = new Date(today + 'T00:00:00+05:30');
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });

  container.innerHTML = groups.map(group => {
    let dayLabel;
    if (group.dateKey === today) {
      dayLabel = 'Today';
    } else if (group.dateKey === yesterdayStr) {
      dayLabel = 'Yesterday';
    } else {
      dayLabel = formatDate(group.date);
    }

    const entriesHtml = group.entries.map(entry => {
      const typeConfig = getActivityTypeConfig(entry.type);
      const time = formatRelativeTime(new Date(entry.timestamp));

      return `
        <div class="activity-entry">
          <div class="activity-icon" style="color:${typeConfig.color}; background:${typeConfig.color}15;">
            ${getIcon(typeConfig.icon, 16)}
          </div>
          <div class="activity-content">
            <div class="activity-title">${entry.title}</div>
            ${entry.details ? `<div class="activity-details">${entry.details}</div>` : ''}
          </div>
          <div class="activity-time">${time}</div>
        </div>`;
    }).join('');

    return `
      <div class="activity-day-group">
        <div class="activity-day-header">${dayLabel}</div>
        ${entriesHtml}
      </div>`;
  }).join('');
}

/**
 * Returns icon name and color for a given activity type.
 */
function getActivityTypeConfig(type) {
  const config = {
    task_created:   { icon: 'plus',         color: '#6366f1' },
    task_started:   { icon: 'flag',         color: '#f59e0b' },
    task_completed: { icon: 'check-circle', color: '#10b981' },
    call:           { icon: 'phone',        color: '#3b82f6' },
    recurring_run:  { icon: 'recurring',    color: '#8b5cf6' }
  };
  return config[type] || { icon: 'activity', color: '#6b7280' };
}


// -- Activity Filter --

function filterActivity(type) {
  AppState.activityFilter = type;
  document.querySelectorAll('#activityFilters button').forEach(b => {
    b.classList.toggle('active', b.dataset.filter === type);
  });
  renderActivityView();
}
// ============================================================
// Goals View
// ============================================================

function renderGoalsView() {
  const container = document.getElementById('goalsGrid');
  if (!container) return;

  const filter = document.getElementById('goalStatusFilter')?.value || 'all';
  let goals = AppState.goals || [];
  if (filter !== 'all') {
    goals = goals.filter(g => g.status === filter);
  }

  if (goals.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1">
        <div class="empty-state-icon">${getIcon('target', 40)}</div>
        <p>${filter === 'all' ? 'No goals yet. Tell Andy about something you want to achieve!' : 'No ' + filter + ' goals.'}</p>
      </div>`;
    return;
  }

  container.innerHTML = goals.map(goal => {
    const taskCount = (goal.tasks || []).length;
    const isOverdue = goal.deadline && new Date(goal.deadline) < new Date() && goal.status === 'active';

    return `
      <div class="goal-card priority-${goal.priority}" onclick="openGoalSideSheet('${goal.id}')">
        <div class="goal-card-header">
          <div class="goal-card-title">${escapeHtml(goal.title)}</div>
          <span class="goal-priority-badge ${goal.priority}">${goal.priority}</span>
        </div>
        ${goal.description ? `<div class="goal-card-desc">${escapeHtml(goal.description)}</div>` : ''}
        <div class="goal-progress-bar">
          <div class="goal-progress-fill" style="width: ${goal.progress}%"></div>
        </div>
        <div class="goal-card-footer">
          <span class="goal-status-pill ${goal.status}">${goal.status}</span>
          <div class="goal-meta">
            <span class="goal-progress-text">${goal.progress}%</span>
            ${taskCount > 0 ? `<span class="goal-tasks-badge">${getIcon('list', 12)} ${taskCount} task${taskCount !== 1 ? 's' : ''}</span>` : ''}
            ${goal.deadline ? `<span class="goal-deadline ${isOverdue ? 'overdue' : ''}">${isOverdue ? 'Overdue: ' : ''}${formatDate(new Date(goal.deadline))}</span>` : ''}
          </div>
        </div>
      </div>`;
  }).join('');
}

function openGoalSideSheet(goalId) {
  const goal = (AppState.goals || []).find(g => g.id === goalId);
  if (!goal) return;

  const sheet = document.getElementById('sideSheet');
  const title = document.getElementById('sideSheetTitle');
  const body = document.querySelector('.side-sheet-body');

  title.textContent = goal.title;

  const tasks = goal.tasks || [];
  const isOverdue = goal.deadline && new Date(goal.deadline) < new Date() && goal.status === 'active';

  body.innerHTML = `
    <div class="sheet-field">
      <label>Status</label>
      <span class="goal-status-pill ${goal.status}">${goal.status}</span>
    </div>
    <div class="sheet-field">
      <label>Priority</label>
      <span class="goal-priority-badge ${goal.priority}">${goal.priority}</span>
    </div>
    ${goal.deadline ? `
    <div class="sheet-field">
      <label>Deadline</label>
      <span class="${isOverdue ? 'goal-deadline overdue' : ''}">${formatDate(new Date(goal.deadline))}${isOverdue ? ' (overdue)' : ''}</span>
    </div>` : ''}
    ${goal.description ? `
    <div class="sheet-field">
      <label>Description</label>
      <p style="color: var(--color-text-secondary); line-height: var(--leading-relaxed);">${escapeHtml(goal.description)}</p>
    </div>` : ''}
    <div class="goal-sheet-progress">
      <div class="goal-sheet-progress-header">
        <span>Progress</span>
        <span>${goal.progress}%</span>
      </div>
      <div class="goal-sheet-progress-bar">
        <div class="goal-sheet-progress-fill" style="width: ${goal.progress}%"></div>
      </div>
    </div>
    <div class="goal-sheet-tasks">
      <h4>Linked Tasks (${tasks.length})</h4>
      ${tasks.length === 0 ? '<p style="color: var(--color-text-tertiary); font-size: var(--text-body);">No tasks linked yet.</p>' :
        tasks.map(t => `
          <div class="goal-task-item">
            <div class="goal-task-status ${t.status}"></div>
            <div class="goal-task-prompt">${escapeHtml(t.prompt.slice(0, 80))}</div>
            ${t.next_run ? `<div class="goal-task-next">Next: ${formatRelativeTime(new Date(t.next_run))}</div>` : ''}
          </div>`).join('')
      }
    </div>
    <div class="sheet-field" style="margin-top: var(--space-4);">
      <label>Created</label>
      <span>${formatDate(new Date(goal.created_at))}</span>
    </div>
    ${goal.completed_at ? `
    <div class="sheet-field">
      <label>Completed</label>
      <span>${formatDate(new Date(goal.completed_at))}</span>
    </div>` : ''}
  `;

  // Hide edit button (not applicable for goals)
  const editBtn = document.querySelector('.side-sheet-actions button[onclick="editTaskFromSheet()"]');
  if (editBtn) editBtn.style.display = 'none';

  sheet.classList.add('open');
  document.getElementById('sideSheetOverlay').classList.add('open');
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// -- Goal Modal --

function openNewGoalModal() {
  document.getElementById('goalModalTitle').textContent = 'New Goal';
  document.getElementById('goalId').value = '';
  document.getElementById('goalTitle').value = '';
  document.getElementById('goalDescription').value = '';
  document.getElementById('goalPriority').value = 'medium';
  document.getElementById('goalDeadline').value = '';
  document.getElementById('goalModal').classList.add('active');
}

function closeGoalModal() {
  document.getElementById('goalModal').classList.remove('active');
}

async function saveGoal(event) {
  event.preventDefault();
  const title = document.getElementById('goalTitle').value.trim();
  const description = document.getElementById('goalDescription').value.trim() || null;
  const priority = document.getElementById('goalPriority').value;
  const deadlineInput = document.getElementById('goalDeadline').value;
  const deadline = deadlineInput ? new Date(deadlineInput).toISOString() : null;

  if (!title) return false;

  try {
    const res = await fetch('http://localhost:3001/goals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description, priority, deadline }),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'Failed to create goal');
    }
    // Refresh goals from API
    await loadGoals();
  } catch(e) {
    alert(e.message || 'Failed to create goal  is the API running?');
    return false;
  }

  renderCurrentView();
  renderSidebarWidgets();
  closeGoalModal();
  return false;
}

// Goals are now managed entirely via the API  no localStorage operations needed

// ============================================================
// Part 4: Interaction & Event Handling
// Assumes: AppState, getIcon, render*, load*, switchView, etc.
// ============================================================

// ------------------------------------------------------------
// Sub-tasks & File Attachments helpers
// ------------------------------------------------------------

let modalSubtasks = [];
let modalFiles = [];

function getTaskFiles(task) {
  const files = [];
  if (task.file && typeof task.file === 'string') {
    files.push({ name: task.file.split('/').pop() || task.file, path: task.file });
  }
  if (Array.isArray(task.files)) {
    task.files.forEach(f => files.push(f));
  }
  return files;
}

// -- Modal subtask helpers --
function renderModalSubtasks() {
  const container = document.getElementById('modalSubtasksList');
  if (!container) return;
  if (modalSubtasks.length === 0) {
    container.innerHTML = '';
    return;
  }
  container.innerHTML = modalSubtasks.map((st, i) => `
    <div class="modal-subtask-item">
      <input type="checkbox" ${st.completed ? 'checked' : ''} onchange="modalSubtasks[${i}].completed = this.checked">
      <span>${st.title}</span>
      <button type="button" onclick="modalSubtasks.splice(${i}, 1); renderModalSubtasks();">${getIcon('x', 14)}</button>
    </div>
  `).join('');
}

function addSubtaskInModal() {
  const input = document.getElementById('modalSubtaskInput');
  const title = input.value.trim();
  if (!title) return;
  modalSubtasks.push({ id: Date.now(), title, completed: false });
  input.value = '';
  renderModalSubtasks();
}

// -- Modal file helpers --
function renderModalFiles() {
  const container = document.getElementById('modalFilesList');
  if (!container) return;
  if (modalFiles.length === 0) {
    container.innerHTML = '';
    return;
  }
  container.innerHTML = modalFiles.map((f, i) => `
    <div class="modal-file-item">
      ${getIcon('file', 14)}
      <span>${f.name}</span>
      <button type="button" onclick="modalFiles.splice(${i}, 1); renderModalFiles();">${getIcon('x', 14)}</button>
    </div>
  `).join('');
}

function addFileInModal() {
  const nameInput = document.getElementById('modalFileName');
  const pathInput = document.getElementById('modalFilePath');
  const name = nameInput.value.trim();
  const path = pathInput.value.trim();
  if (!name && !path) return;
  modalFiles.push({ name: name || path.split('/').pop() || 'file', path: path || '' });
  nameInput.value = '';
  pathInput.value = '';
  renderModalFiles();
}

// -- Side sheet subtask helpers --
function toggleSubtask(taskId, subtaskId, checked) {
  const task = AppState.tasks.find(t => t.id == taskId);
  if (!task || !task.subtasks) return;
  const st = task.subtasks.find(s => s.id == subtaskId);
  if (st) st.completed = checked;
  localStorage.setItem('andy_tasks', JSON.stringify(AppState.tasks));
  openTaskSideSheet(taskId);
  renderCurrentView();
}

function deleteSubtask(taskId, subtaskId) {
  const task = AppState.tasks.find(t => t.id == taskId);
  if (!task || !task.subtasks) return;
  task.subtasks = task.subtasks.filter(s => s.id != subtaskId);
  localStorage.setItem('andy_tasks', JSON.stringify(AppState.tasks));
  openTaskSideSheet(taskId);
  renderCurrentView();
}

function addSubtaskFromSheet(taskId) {
  const input = document.getElementById('sheetSubtaskInput');
  const title = input.value.trim();
  if (!title) return;
  const task = AppState.tasks.find(t => t.id == taskId);
  if (!task) return;
  if (!task.subtasks) task.subtasks = [];
  task.subtasks.push({ id: Date.now(), title, completed: false });
  input.value = '';
  localStorage.setItem('andy_tasks', JSON.stringify(AppState.tasks));
  openTaskSideSheet(taskId);
  renderCurrentView();
}

// ------------------------------------------------------------
// Task CRUD
// ------------------------------------------------------------

function openNewTaskModal() {
  document.getElementById('modalTitle').textContent = 'New Task';
  document.getElementById('taskForm').reset();
  document.getElementById('taskId').value = '';
  modalSubtasks = [];
  modalFiles = [];
  renderModalSubtasks();
  renderModalFiles();
  document.getElementById('taskModal').classList.add('active');
  document.getElementById('taskTitle').focus();
}

function openEditTaskModal(taskId) {
  const task = AppState.tasks.find(t => t.id == taskId);
  if (!task) return;
  document.getElementById('modalTitle').textContent = 'Edit Task';
  document.getElementById('taskId').value = task.id;
  document.getElementById('taskTitle').value = task.title;
  document.getElementById('taskDescription').value = task.description || '';
  document.getElementById('taskPriority').value = task.priority;
  document.getElementById('taskStatus').value = task.status;
  document.getElementById('taskDeadline').value = task.deadline || '';
  modalSubtasks = (task.subtasks || []).map(s => ({ ...s }));
  modalFiles = getTaskFiles(task).map(f => ({ ...f }));
  renderModalSubtasks();
  renderModalFiles();
  document.getElementById('taskModal').classList.add('active');
}

function closeTaskModal() {
  document.getElementById('taskModal').classList.remove('active');
}

function saveTask(e) {
  e.preventDefault();
  const taskId = document.getElementById('taskId').value;
  const title = document.getElementById('taskTitle').value;
  const description = document.getElementById('taskDescription').value;
  const priority = document.getElementById('taskPriority').value;
  const status = document.getElementById('taskStatus').value;
  const deadline = document.getElementById('taskDeadline').value || null;

  if (taskId) {
    const task = AppState.tasks.find(t => t.id == taskId);
    if (task) {
      // Track status changes
      if (task.status !== status) {
        if (status === 'progress' && !task.startedAt) task.startedAt = new Date().toISOString();
        if (status === 'completed' && !task.completedAt) task.completedAt = new Date().toISOString();
      }
      task.title = title;
      task.description = description;
      task.priority = priority;
      task.status = status;
      task.deadline = deadline;
      task.subtasks = modalSubtasks;
      task.files = modalFiles;
      if (task.file) delete task.file; // migrate old field
    }
  } else {
    AppState.tasks.push({
      id: Date.now(),
      title, description, status, priority, deadline,
      subtasks: modalSubtasks,
      files: modalFiles,
      timestamp: new Date().toISOString()
    });
  }

  localStorage.setItem('andy_tasks', JSON.stringify(AppState.tasks));
  renderCurrentView();
  renderSidebarWidgets();
  closeTaskModal();
  return false;
}

function deleteTask(taskId) {
  if (confirm('Delete this task?')) {
    AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
    localStorage.setItem('andy_tasks', JSON.stringify(AppState.tasks));
    closeSideSheet();
    renderCurrentView();
    renderSidebarWidgets();
  }
}

// ------------------------------------------------------------
// Side Sheet (Task Detail)
// ------------------------------------------------------------

function openTaskSideSheet(taskId) {
  const task = AppState.tasks.find(t => t.id == taskId);
  if (!task) return;
  AppState.selectedTask = task;

  // Restore edit button (may have been hidden by goal side sheet)
  const editBtn = document.querySelector('.side-sheet-actions button[onclick="editTaskFromSheet()"]');
  if (editBtn) editBtn.style.display = '';

  document.getElementById('sideSheetTitle').textContent = task.title;

  // Status with colored badge
  const statusColors = { backlog: '#6366f1', progress: '#f59e0b', completed: '#10b981' };
  const statusLabels = { backlog: 'Backlog', progress: 'In Progress', completed: 'Completed' };
  document.getElementById('sheetStatus').innerHTML = `<span style="display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;background:${statusColors[task.status]}22;color:${statusColors[task.status]};font-weight:500;font-size:13px;">${statusLabels[task.status]}</span>`;

  // Priority with dot indicator
  const prioColors = { high: '#ef4444', medium: '#f59e0b', low: '#10b981' };
  document.getElementById('sheetPriority').innerHTML = `<span style="display:inline-flex;align-items:center;gap:6px;font-size:13px;"><span style="width:8px;height:8px;border-radius:50%;background:${prioColors[task.priority]}"></span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>`;

  document.getElementById('sheetDeadline').textContent = task.deadline ? formatDate(new Date(task.deadline)) : 'None';
  document.getElementById('sheetCreated').textContent = formatDate(new Date(task.timestamp));
  document.getElementById('sheetDescription').textContent = task.description || 'No description';

  // Subtasks
  const subtasksEl = document.getElementById('sheetSubtasks');
  if (task.subtasks && task.subtasks.length > 0) {
    const done = task.subtasks.filter(s => s.completed).length;
    const total = task.subtasks.length;
    const pct = Math.round((done / total) * 100);
    subtasksEl.innerHTML = `
      <div class="sheet-field">
        <label>Sub-tasks (${done}/${total})</label>
        <div class="subtask-progress-bar"><div class="subtask-progress-fill" style="width:${pct}%"></div></div>
        <ul class="subtask-list">
          ${task.subtasks.map(s => `
            <li class="subtask-item ${s.completed ? 'completed' : ''}">
              <input type="checkbox" ${s.completed ? 'checked' : ''} onchange="toggleSubtask(${task.id}, ${s.id}, this.checked)">
              <span class="subtask-title">${s.title}</span>
              <button class="subtask-delete" onclick="deleteSubtask(${task.id}, ${s.id})">${getIcon('x', 14)}</button>
            </li>`).join('')}
        </ul>
        <div class="subtask-add-row">
          <input type="text" id="sheetSubtaskInput" placeholder="Add sub-task..." onkeydown="if(event.key==='Enter')addSubtaskFromSheet(${task.id})">
          <button onclick="addSubtaskFromSheet(${task.id})">Add</button>
        </div>
      </div>`;
  } else {
    subtasksEl.innerHTML = `
      <div class="sheet-field">
        <label>Sub-tasks</label>
        <div class="subtask-add-row">
          <input type="text" id="sheetSubtaskInput" placeholder="Add sub-task..." onkeydown="if(event.key==='Enter')addSubtaskFromSheet(${task.id})">
          <button onclick="addSubtaskFromSheet(${task.id})">Add</button>
        </div>
      </div>`;
  }

  // Files
  const filesEl = document.getElementById('sheetFiles');
  const taskFiles = getTaskFiles(task);
  if (taskFiles.length > 0) {
    filesEl.innerHTML = `
      <div class="sheet-field">
        <label>Files (${taskFiles.length})</label>
        <ul class="file-list">
          ${taskFiles.map(f => `
            <li class="file-item">
              ${getIcon('file', 14)}
              <a href="${f.path}" target="_blank" rel="noopener">${f.name}</a>
            </li>`).join('')}
        </ul>
      </div>`;
  } else {
    filesEl.innerHTML = '';
  }

  document.getElementById('sideSheet').classList.add('open');
  document.getElementById('sideSheetOverlay').classList.add('open');
}

function closeSideSheet() {
  document.getElementById('sideSheet').classList.remove('open');
  document.getElementById('sideSheetOverlay').classList.remove('open');
  AppState.selectedTask = null;
}

function editTaskFromSheet() {
  if (AppState.selectedTask) {
    closeSideSheet();
    openEditTaskModal(AppState.selectedTask.id);
  }
}

// ------------------------------------------------------------
// Drag and Drop (Kanban)
// ------------------------------------------------------------

function setupDragAndDrop() {
  document.querySelectorAll('.kanban-cards').forEach(zone => {
    zone.addEventListener('dragover', e => {
      e.preventDefault();
      zone.classList.add('drag-over');
    });
    zone.addEventListener('dragleave', e => {
      zone.classList.remove('drag-over');
    });
    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.classList.remove('drag-over');
      const taskId = e.dataTransfer.getData('text/plain');
      const newStatus = zone.dataset.status;
      const task = AppState.tasks.find(t => t.id == taskId);
      if (task && task.status !== newStatus) {
        if (newStatus === 'progress' && !task.startedAt) task.startedAt = new Date().toISOString();
        if (newStatus === 'completed' && !task.completedAt) task.completedAt = new Date().toISOString();
        task.status = newStatus;
        localStorage.setItem('andy_tasks', JSON.stringify(AppState.tasks));
        renderCurrentView();
        renderSidebarWidgets();
      }
    });
  });
}

// ------------------------------------------------------------
// Command Palette
// ------------------------------------------------------------

function openCommandPalette() {
  AppState.commandPaletteOpen = true;
  AppState.commandSelectedIndex = 0;
  document.getElementById('commandPalette').classList.add('open');
  document.getElementById('commandInput').value = '';
  document.getElementById('commandResults').innerHTML = renderCommandHints();
  setTimeout(() => document.getElementById('commandInput').focus(), 50);
}

function closeCommandPalette() {
  AppState.commandPaletteOpen = false;
  document.getElementById('commandPalette').classList.remove('open');
}

function renderCommandHints() {
  return `
    <div>
      <div class="command-palette-section-label">Quick Actions</div>
      <div class="command-palette-result" onclick="closeCommandPalette();switchView('home')">
        ${getIcon('home', 16)} <span>Go to Home</span>
      </div>
      <div class="command-palette-result" onclick="closeCommandPalette();switchView('tasks')">
        ${getIcon('tasks', 16)} <span>Go to Tasks</span>
      </div>
      <div class="command-palette-result" onclick="closeCommandPalette();switchView('calendar')">
        ${getIcon('calendar', 16)} <span>Go to Calendar</span>
      </div>
      <div class="command-palette-result" onclick="closeCommandPalette();openNewTaskModal()">
        ${getIcon('plus', 16)} <span>Create New Task</span>
      </div>
    </div>
  `;
}

function handleCommandSearch() {
  const query = document.getElementById('commandInput').value.toLowerCase().trim();
  const container = document.getElementById('commandResults');

  if (!query) {
    container.innerHTML = renderCommandHints();
    AppState.commandSelectedIndex = 0;
    return;
  }

  const results = [];

  // Search tasks
  AppState.tasks.filter(t =>
    t.title.toLowerCase().includes(query) ||
    (t.description || '').toLowerCase().includes(query)
  ).slice(0, 5).forEach(t => {
    results.push({
      type: 'task',
      icon: 'tasks',
      title: t.title,
      detail: t.status,
      action: () => { closeCommandPalette(); switchView('tasks'); openTaskSideSheet(t.id); }
    });
  });

  // Search calendar events
  AppState.allCalendarEvents.filter(e =>
    e.summary.toLowerCase().includes(query) ||
    (e.description || '').toLowerCase().includes(query)
  ).slice(0, 5).forEach(e => {
    results.push({
      type: 'event',
      icon: 'calendar',
      title: e.summary,
      detail: e.allDay ? formatDate(e._start) : formatTime(e._start) + ' \u00b7 ' + formatDate(e._start),
      action: () => { closeCommandPalette(); switchView('calendar'); }
    });
  });

  // Search recurring tasks
  AppState.recurringTasks.filter(t =>
    t.prompt.toLowerCase().includes(query) ||
    (t.description || '').toLowerCase().includes(query)
  ).forEach(t => {
    results.push({
      type: 'recurring',
      icon: 'recurring',
      title: t.prompt,
      detail: t.status,
      action: () => { closeCommandPalette(); switchView('recurring'); }
    });
  });

  if (results.length === 0) {
    container.innerHTML = '<div class="command-palette-empty">No results found</div>';
    return;
  }

  AppState.commandSelectedIndex = 0;
  container.innerHTML = results.map((r, i) => `
    <div class="command-palette-result ${i === 0 ? 'selected' : ''}" data-index="${i}" onclick="commandResults[${i}].action()">
      <span class="result-icon">${getIcon(r.icon, 16)}</span>
      <div class="result-info">
        <div class="result-title">${r.title}</div>
        <div class="result-description">${r.detail}</div>
      </div>
      <span class="result-shortcut">${r.type}</span>
    </div>
  `).join('');

  // Store results for keyboard navigation
  window.commandResults = results;
}

// ------------------------------------------------------------
// Keyboard Shortcuts
// ------------------------------------------------------------

function showShortcuts() {
  document.getElementById('shortcutsOverlay').style.display = 'flex';
}

function closeShortcuts() {
  document.getElementById('shortcutsOverlay').style.display = 'none';
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

document.addEventListener('keydown', (e) => {
  const target = e.target;
  const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT';

  // Command palette keyboard navigation
  if (AppState.commandPaletteOpen) {
    if (e.key === 'Escape') {
      e.preventDefault();
      closeCommandPalette();
      return;
    }
    if (e.key === 'ArrowDown' && window.commandResults) {
      e.preventDefault();
      AppState.commandSelectedIndex = Math.min(AppState.commandSelectedIndex + 1, window.commandResults.length - 1);
      updateCommandSelection();
      return;
    }
    if (e.key === 'ArrowUp' && window.commandResults) {
      e.preventDefault();
      AppState.commandSelectedIndex = Math.max(AppState.commandSelectedIndex - 1, 0);
      updateCommandSelection();
      return;
    }
    if (e.key === 'Enter' && window.commandResults && window.commandResults[AppState.commandSelectedIndex]) {
      e.preventDefault();
      window.commandResults[AppState.commandSelectedIndex].action();
      return;
    }
    return; // Don't process other shortcuts while palette is open
  }

  // Cmd/Ctrl+K - Command palette
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    openCommandPalette();
    return;
  }

  // Cmd/Ctrl+N - New task
  if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
    e.preventDefault();
    openNewTaskModal();
    return;
  }

  // Escape - Close modals/overlays
  if (e.key === 'Escape') {
    if (document.getElementById('taskModal').classList.contains('active')) {
      closeTaskModal();
    } else if (document.getElementById('sideSheet').classList.contains('open')) {
      closeSideSheet();
    } else if (document.getElementById('shortcutsOverlay').style.display !== 'none') {
      closeShortcuts();
    } else if (document.getElementById('notificationPanel').style.display !== 'none') {
      document.getElementById('notificationPanel').style.display = 'none';
    }
    return;
  }

  // Don't process single-key shortcuts when in input fields
  if (isInput) return;

  // Number keys 1-5 for view switching
  if (e.key === '1') switchView('home');
  if (e.key === '2') switchView('tasks');
  if (e.key === '3') switchView('calendar');
  if (e.key === '4') switchView('recurring');
  if (e.key === '5') switchView('activity');

  // D - Toggle theme
  if (e.key === 'd' || e.key === 'D') cycleTheme();

  // ? - Show shortcuts
  if (e.key === '?') showShortcuts();
});

function updateCommandSelection() {
  document.querySelectorAll('.command-palette-result').forEach((el, i) => {
    el.classList.toggle('selected', i === AppState.commandSelectedIndex);
  });
  // Scroll selected into view
  const selected = document.querySelector('.command-palette-result.selected');
  if (selected) selected.scrollIntoView({ block: 'nearest' });
}

// ------------------------------------------------------------
// App Initialization
// ------------------------------------------------------------

async function init() {
  // Apply theme first
  applyTheme();

  // Initialize calendar week start
  AppState.calendarWeekStart = getWeekStart(new Date());

  // Inject icons
  injectIcons();

  // Load all data
  await refreshAllData();

  // Setup drag and drop
  setupDragAndDrop();

  // Auto-refresh every 30 seconds
  setInterval(refreshAllData, 30000);

  // Update greeting date
  const now = new Date();
  document.getElementById('greetingDate').textContent = now.toLocaleDateString('en-IN', {
    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', timeZone: 'Asia/Kolkata'
  });
}

// Start the app
init();
</script>
</body>
</html>
